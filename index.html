<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام التقييم الذكي - كمال الخطابي</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Cairo', 'sans-serif'],
                    },
                    colors: {
                        primary: '#1e40af', // Blue 800
                        secondary: '#0f766e', // Teal 700
                        accent: '#b45309', // Amber 700
                        purple: '#7e22ce', // Purple 700
                    }
                }
            }
        }
    </script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- SheetJS (XLSX) -->
    <script lang="javascript" src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- Chart.js & Datalabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- jsPDF & AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f3f4f6; }
        .hidden-print { display: none; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            @page { size: landscape; margin: 10mm; }
            body { background-color: white; }
            /* Force charts to print properly */
            canvas { max-width: 100% !important; height: auto !important; }
            
            /* 5 Print Modal Specifics */
            body.print-mode-modal #root > * { display: none !important; }
            body.print-mode-modal .printable-modal { 
                position: absolute !important; top: 0 !important; left: 0 !important; 
                width: 100% !important; height: auto !important; 
                background: white !important; z-index: 9999 !important; display: block !important; 
            }
            body.print-mode-modal .printable-modal-content { max-height: none !important; overflow: visible !important; }
            body.print-mode-modal .no-print-modal { display: none !important; }
            body.print-mode-modal .bg-black { background: none !important; }
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // تسجيل إضافة ChartDataLabels
        Chart.register(ChartDataLabels);

        // --- مكون الأيقونة الآمن ---
        const LucideIcon = React.memo(({ name, className, onClick }) => {
            const ref = useRef(null);

            useEffect(() => {
                if (window.lucide && ref.current) {
                    window.lucide.createIcons({
                        root: ref.current,
                        nameAttr: 'data-lucide',
                        attrs: {
                            class: className 
                        }
                    });
                }
            }, [name, className]);

            return (
                <span 
                    ref={ref} 
                    onClick={onClick}
                    style={{ display: 'inline-flex', verticalAlign: 'middle', cursor: onClick ? 'pointer' : 'default' }}
                    dangerouslySetInnerHTML={{ __html: `<i data-lucide="${name}" class="${className}"></i>` }}
                />
            );
        });

        // --- قاموس الأيقونات ---
        const Icons = {
            Upload: () => <LucideIcon name="upload-cloud" className="w-6 h-6" />,
            Check: () => <LucideIcon name="check-circle" className="w-6 h-6 text-green-500" />,
            Alert: () => <LucideIcon name="alert-circle" className="w-5 h-5" />,
            File: () => <LucideIcon name="file-spreadsheet" className="w-6 h-6" />,
            Help: () => <LucideIcon name="help-circle" className="w-6 h-6" />,
            Next: () => <LucideIcon name="arrow-left" className="w-5 h-5" />,
            Prev: () => <LucideIcon name="arrow-right" className="w-5 h-5" />,
            Chart: () => <LucideIcon name="bar-chart-2" className="w-5 h-5" />,
            Download: () => <LucideIcon name="download" className="w-5 h-5" />,
            Home: () => <LucideIcon name="home" className="w-5 h-5" />,
            Save: () => <LucideIcon name="save" className="w-5 h-5" />,
            XCircle: () => <LucideIcon name="x-circle" className="w-5 h-5" />,
            Edit: () => <LucideIcon name="edit" className="w-5 h-5" />,
            Printer: () => <LucideIcon name="printer" className="w-5 h-5" />,
            Search: () => <LucideIcon name="search" className="w-5 h-5" />,
            Message: () => <LucideIcon name="message-square" className="w-5 h-5" />,
            Refresh: () => <LucideIcon name="rotate-ccw" className="w-5 h-5" />,
            Wand: () => <LucideIcon name="wand-2" className="w-5 h-5" />,
            Sun: () => <LucideIcon name="sun" className="w-5 h-5" />,
            Moon: () => <LucideIcon name="moon" className="w-5 h-5" />,
            Languages: () => <LucideIcon name="languages" className="w-5 h-5" />,
        };

        // --- دوال مساعدة ذكية ---
        const SmartParser = {
            synonyms: {
                name: ['الاسم', 'إسم', 'الموظف', 'الطالب', 'المعلم', 'name', 'full name', 'employee'],
                branch: ['الفرع', 'القسم', 'الإدارة', 'branch', 'section', 'department', 'الفصل'],
                item: ['البند', 'السؤال', 'المعيار', 'العبارة', 'item', 'question', 'criteria'],
                domain: ['المجال', 'المحور', 'التصنيف', 'domain', 'category', 'topic']
            },

            findHeaderRow: (data) => {
                let bestRowIndex = -1;
                let maxMatches = 0;
                const limit = Math.min(data.length, 20);
                
                for (let i = 0; i < limit; i++) {
                    const row = data[i];
                    let matches = 0;
                    if (!row || row.length === 0) continue;

                    const rowValues = row.map(cell => String(cell).toLowerCase().trim());
                    const allKeywords = [...SmartParser.synonyms.name, ...SmartParser.synonyms.item];
                    
                    rowValues.forEach(val => {
                        if (allKeywords.some(key => val.includes(key))) matches++;
                    });

                    if (matches > maxMatches) {
                        maxMatches = matches;
                        bestRowIndex = i;
                    }
                }
                return bestRowIndex === -1 ? 0 : bestRowIndex;
            },

            cleanData: (rawData, type) => {
                if (!rawData || rawData.length === 0) return [];
                const headerIndex = SmartParser.findHeaderRow(rawData);
                const headers = rawData[headerIndex].map(h => String(h).toLowerCase().trim());
                
                const data = [];
                let mainColIdx = -1;
                let subColIdx = -1;
                
                const mainKeys = type === 'names' ? SmartParser.synonyms.name : SmartParser.synonyms.item;
                const subKeys = type === 'names' ? SmartParser.synonyms.branch : SmartParser.synonyms.domain;

                mainColIdx = headers.findIndex(h => mainKeys.some(k => h.includes(k)));
                subColIdx = headers.findIndex(h => subKeys.some(k => h.includes(k)));

                if (mainColIdx === -1) mainColIdx = 0;

                for (let i = headerIndex + 1; i < rawData.length; i++) {
                    const row = rawData[i];
                    if (!row || row.length <= mainColIdx) continue;
                    
                    const mainVal = row[mainColIdx];
                    if (!mainVal) continue;

                    data.push({
                        id: i,
                        main: String(mainVal).trim(),
                        sub: subColIdx !== -1 && row[subColIdx] ? String(row[subColIdx]).trim() : (type === 'names' ? 'عام' : 'بدون مجال')
                    });
                }
                return data;
            }
        };

        const numberToText = (num) => {
            const list = ['الأول', 'الثاني', 'الثالث', 'الرابع', 'الخامس', 'السادس', 'السابع', 'الثامن', 'التاسع', 'العاشر'];
            return list[num] || `${num + 1}`;
        };

        // --- دالة حساب التقدير اللفظي (عامة) ---
        const getRating = (percent, lang = 'ar') => {
            const labels = {
                ar: { excellent: 'ممتاز', very_good: 'جيد جداً', good: 'جيد', acceptable: 'مقبول', weak: 'ضعيف' },
                en: { excellent: 'Excellent', very_good: 'Very Good', good: 'Good', acceptable: 'Acceptable', weak: 'Weak' }
            };
            const l = labels[lang] || labels.ar;
            
            if (percent >= 90) return { label: l.excellent, color: '#10b981', class: 'bg-green-100 text-green-800' };
            if (percent >= 80) return { label: l.very_good, color: '#3b82f6', class: 'bg-blue-100 text-blue-800' };
            if (percent >= 70) return { label: l.good, color: '#06b6d4', class: 'bg-cyan-100 text-cyan-800' };
            if (percent >= 60) return { label: l.acceptable, color: '#f59e0b', class: 'bg-yellow-100 text-yellow-800' };
            return { label: l.weak, color: '#ef4444', class: 'bg-red-100 text-red-800' };
        };

        // --- مكون الجدول للإدخال اليدوي ---
        const DataEditorTable = ({ data, type, onChange, t }) => {
            const [rows, setRows] = useState([]);
            
            // تحديث الصفوف عند تغير البيانات من المصدر (مثل رفع ملف)
            useEffect(() => {
                if (data && data.length > 0) {
                    setRows(data.map(d => [d.main, d.sub]));
                } else {
                    // إذا لم تكن هناك بيانات، نبدأ بصفوف فارغة فقط إذا كانت المصفوفة فارغة تماماً
                    if (rows.length === 0) setRows([['', ''], ['', ''], ['', '']]);
                }
            }, [data]);

            const headers = type === 'names' ? [t('name_label'), t('branch_label')] : [t('item_label'), t('domain_label')];

            const updateRow = (i, col, val) => {
                const newRows = [...rows];
                newRows[i][col] = val;
                setRows(newRows);
            };

            const addRow = () => setRows([...rows, ['', '']]);

            const removeRow = (i) => {
                const newRows = rows.filter((_, idx) => idx !== i);
                setRows(newRows);
                saveData(newRows);
            };

            const saveData = (currentRows) => {
                // تحويل البيانات لتنسيق يقبله SmartParser
                const rawData = [headers, ...currentRows];
                const processed = SmartParser.cleanData(rawData, type);
                onChange(processed);
            };

            return (
                <div className="border rounded-lg overflow-hidden bg-white shadow-sm mt-2">
                    <div className="max-h-60 overflow-y-auto">
                        <table className="w-full text-sm text-right relative border-collapse">
                            <thead className="bg-gray-100 text-gray-700 font-bold sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th className="p-2 border-b w-10 text-center bg-gray-100">#</th>
                                    <th className="p-2 border-b bg-gray-100">{headers[0]}</th>
                                    <th className="p-2 border-b w-1/3 bg-gray-100">{headers[1]}</th>
                                    <th className="p-2 border-b w-10 bg-gray-100"></th>
                                </tr>
                            </thead>
                            <tbody>
                                {rows.map((row, i) => (
                                    <tr key={i} className="border-b last:border-0 hover:bg-blue-50 group transition-colors">
                                        <td className="p-2 text-center text-gray-400 text-xs">{i + 1}</td>
                                        <td className="p-0"><input type="text" className="w-full p-2 bg-transparent outline-none focus:ring-2 focus:ring-inset focus:ring-blue-200" value={row[0]} onChange={e => updateRow(i, 0, e.target.value)} onBlur={() => saveData(rows)} /></td>
                                        <td className="p-0 border-r"><input type="text" className="w-full p-2 bg-transparent outline-none focus:ring-2 focus:ring-inset focus:ring-blue-200" value={row[1]} onChange={e => updateRow(i, 1, e.target.value)} onBlur={() => saveData(rows)} /></td>
                                        <td className="p-0 text-center"><button onClick={() => removeRow(i)} className="text-gray-300 hover:text-red-500 p-2 opacity-0 group-hover:opacity-100 transition-opacity"><Icons.XCircle /></button></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    <button onClick={addRow} className="w-full py-2 bg-gray-50 text-primary font-bold hover:bg-gray-100 text-xs border-t transition-colors flex items-center justify-center gap-1"><Icons.Edit /> {t('add_row')}</button>
                </div>
            );
        };

        // --- المكونات ---

        const Modal = ({ isOpen, onClose, title, children, className = "" }) => {
            if (!isOpen) return null;
            return (
                <div className={`fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 fade-in ${className}`}>
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-5xl overflow-hidden flex flex-col max-h-[95vh] printable-modal-content">
                        <div className="bg-primary px-6 py-4 flex justify-between items-center no-print-modal shrink-0">
                            <h3 className="text-white font-bold text-lg">{title}</h3>
                            <button onClick={onClose} className="text-white hover:text-gray-200 text-2xl">&times;</button>
                        </div>
                        <div className="p-6 overflow-auto printable-modal-content flex-1 bg-gray-100 flex justify-center">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Translations ---
        const translations = {
            ar: {
                title: "نظام التقييم الذكي",
                welcome_desc: "مرحباً بك في النظام الأكثر دقة وسهولة لإدارة التقييمات.\nيهدف هذا التطبيق لتبسيط عملية الرصد والتحليل للحصول على نتائج دقيقة وقابلة للتطوير.",
                start: "موافق، لنبدأ",
                dev_by: "تطوير كمال الخطابي 007781414133",
                setup_title: "إعداد التقييم",
                step1: "1. البنود",
                step2: "2. الأسماء",
                step3: "3. إعدادات الدرجات",
                step4: "4. بيانات التقرير (اختياري)",
                upload_excel: "رفع ملف Excel",
                manual_entry: "أو يمكنك الادخال يدوياً في هذا الجدول:",
                recognized_items: "تم التعرف على: {count} بند",
                recognized_names: "تم التعرف على: {count} اسم",
                max_score: "الدرجة القصوى:",
                reset_scores: "تصفير النتائج",
                org_name: "اسم الجهة",
                evaluator_name: "اسم معد التقييم",
                logo: "شعار الجهة",
                start_eval: "ابدأ التقييم",
                help_guide: "دليل الاستخدام",
                help_text: "قم برفع ملف البنود وملف الأسماء.\nيدعم النظام قراءة ملفات Excel حتى لو كانت العناوين مختلفة قليلاً.\nاستخدم زر \"حفظ المسودة\" للحفاظ على عملك في حال انقطاع الانترنت أو إغلاق المتصفح.",
                draft_found: "يوجد تقييم محفوظ سابقاً (مسودة)، هل تريد استكماله؟",
                restore_draft: "استرجاع المسودة",
                delete_draft: "حذف المسودة",
                domain: "المجال",
                save_draft: "حفظ مسودة",
                apply_all: "تطبيق على الكل",
                reset_item: "تصفير البند الحالي",
                cancel_return: "إلغاء وعودة",
                prev: "السابق",
                next: "التالي",
                finish: "انتهاء التقييم",
                settings: "الإعدادات",
                missing_alert: "يرجى تقييم جميع الأسماء قبل الانتقال!",
                note_placeholder: "اكتب ملاحظات عامة حول هذا الشخص...",
                results_title: "النتائج التفصيلية",
                analysis_title: "التحليل والمؤشرات",
                table_view: "الجــدول",
                analysis_view: "لوحة التحليل",
                edit_eval: "تعديل التقييم",
                home: "الرئيسية",
                export_options: "خيارات التصدير:",
                export_excel: "Excel",
                export_pdf_table: "PDF (جدول)",
                export_cards: "تصدير البطاقات (PDF)",
                export_report: "تصدير التقرير الكامل",
                filter_search: "تصفية وبحث:",
                search_placeholder: "بحث بالاسم...",
                branch: "الفرع",
                all: "الكل",
                rating: "التقدير",
                cancel_filter: "إلغاء التصفية",
                show_sums: "إظهار المجاميع",
                hide_sums: "إخفاء المجاميع",
                total: "المجموع",
                percent: "%",
                name_col: "الاسم",
                sum_domain: "مجموع {domain}",
                general_percent: "النسبة العامة",
                total_points: "مجموع النقاط",
                general_notes: "ملاحظات عامة",
                kpi_count: "العدد",
                kpi_avg: "متوسط الأداء العام",
                kpi_names: "مؤشرات الأسماء",
                kpi_branches: "مؤشرات الفروع",
                kpi_domains: "مؤشرات المجالات",
                kpi_items: "مؤشرات البنود",
                best: "الأفضل",
                worst: "الأدنى",
                chart_branch: "أداء الفروع",
                chart_domain: "أداء المجالات",
                chart_items: "أداء البنود",
                chart_names: "أداء الأسماء",
                chart_rating: "توزيع التقديرات",
                item_analysis: "تحليل البنود التفصيلي",
                name_comparison: "مقارنة الأسماء",
                export_pdf_btn: "تصدير PDF",
                add_row: "إضافة صف جديد",
                delete_confirm: "هل أنت متأكد؟",
                warning: "تحذير",
                na: "غ/م",
                items_legend: "دليل البنود:",
                page: "صفحة",
                of: "من",
                save_hint: "احفظ جهدك كمسودة",
                apply_all_prompt: "أدخل الدرجة لتعميمها على الجميع (1-{max}) أو -1 لـ (غ/م):",
                invalid_val: "قيمة غير صحيحة",
                reset_confirm: "هل أنت متأكد من تصفير جميع الاختيارات لهذا البند؟",
                cancel_confirm: "هل أنت متأكد من إلغاء التقييم والعودة للبداية؟ ستفقد البيانات غير المحفوظة.",
                delete_draft_confirm: "هل أنت متأكد من حذف المسودة المحفوظة؟ لا يمكن التراجع عن هذا الإجراء.",
                reset_scores_confirm: "تحذير هام: سيتم حذف جميع الدرجات التي تم رصدها حتى الآن للسماح لك بتعديل الدرجة القصوى.\n\nهل أنت متأكد من رغبتك في تصفير النتائج؟",
                error_items: "يجب رفع ملف البنود أولاً",
                error_names: "يجب رفع ملف الأسماء أولاً",
                error_max_score: "الدرجة القصوى يجب أن تكون بين 1 و 10",
                file_error: "خطأ في قراءة ملف {type}. تأكد من صحة الملف.",
                no_data: "لم يتم العثور على بيانات صالحة",
                item_label: "البند",
                domain_label: "المجال (اختياري)",
                name_label: "الاسم",
                branch_label: "الفرع (اختياري)",
                lang_btn: "English",
                count_unit: "عنصر",
                visible_items: "للعناصر الظاهرة",
                report_date: "التاريخ:",
                report_prep: "إعداد:",
                report_title_default: "تقرير التقييم",
                detailed_results_title: "النتائج التفصيلية لتقييم الموظفين",
                excellent: "ممتاز",
                very_good: "جيد جداً",
                good: "جيد",
                acceptable: "مقبول",
                weak: "ضعيف"
            },
            en: {
                title: "Smart Evaluation System",
                welcome_desc: "Welcome to the most accurate and easy-to-use evaluation management system.\nThis app aims to simplify tracking and analysis for accurate and scalable results.",
                start: "OK, Let's Start",
                dev_by: "Developed by Kamal Al-Khattabi 007781414133",
                setup_title: "Evaluation Setup",
                step1: "1. Items",
                step2: "2. Names",
                step3: "3. Grading Settings",
                step4: "4. Report Data (Optional)",
                upload_excel: "Upload Excel File",
                manual_entry: "Or enter manually in this table:",
                recognized_items: "Recognized: {count} items",
                recognized_names: "Recognized: {count} names",
                max_score: "Max Score:",
                reset_scores: "Reset Results",
                org_name: "Organization Name",
                evaluator_name: "Evaluator Name",
                logo: "Organization Logo",
                start_eval: "Start Evaluation",
                help_guide: "User Guide",
                help_text: "Upload Items and Names files.\nThe system supports Excel files even with slightly different headers.\nUse 'Save Draft' to keep your work in case of internet loss or browser closure.",
                draft_found: "A previously saved draft was found. Do you want to resume it?",
                restore_draft: "Restore Draft",
                delete_draft: "Delete Draft",
                domain: "Domain",
                save_draft: "Save Draft",
                apply_all: "Apply to All",
                reset_item: "Reset Current Item",
                cancel_return: "Cancel & Return",
                prev: "Previous",
                next: "Next",
                finish: "Finish Evaluation",
                settings: "Settings",
                missing_alert: "Please rate all names before proceeding!",
                note_placeholder: "Write general notes about this person...",
                results_title: "Detailed Results",
                analysis_title: "Analysis & Indicators",
                table_view: "Table",
                analysis_view: "Analysis Dashboard",
                edit_eval: "Edit Evaluation",
                home: "Home",
                export_options: "Export Options:",
                export_excel: "Excel",
                export_pdf_table: "PDF (Table)",
                export_cards: "Export Cards (PDF)",
                export_report: "Export Full Report",
                filter_search: "Filter & Search:",
                search_placeholder: "Search by name...",
                branch: "Branch",
                all: "All",
                rating: "Rating",
                cancel_filter: "Clear Filter",
                show_sums: "Show Totals",
                hide_sums: "Hide Totals",
                total: "Total",
                percent: "%",
                name_col: "Name",
                sum_domain: "Total {domain}",
                general_percent: "General Percentage",
                total_points: "Total Points",
                general_notes: "General Notes",
                kpi_count: "Count",
                kpi_avg: "Avg Performance",
                kpi_names: "Names KPIs",
                kpi_branches: "Branches KPIs",
                kpi_domains: "Domains KPIs",
                kpi_items: "Items KPIs",
                best: "Best",
                worst: "Lowest",
                chart_branch: "Branches Performance",
                chart_domain: "Domains Performance",
                chart_items: "Items Performance",
                chart_names: "Names Performance",
                chart_rating: "Ratings Distribution",
                item_analysis: "Detailed Item Analysis",
                name_comparison: "Names Comparison",
                export_pdf_btn: "Export PDF",
                add_row: "Add New Row",
                delete_confirm: "Are you sure?",
                warning: "Warning",
                na: "N/A",
                items_legend: "Items Legend:",
                page: "Page",
                of: "of",
                save_hint: "Save your work as draft",
                apply_all_prompt: "Enter score to apply to all (1-{max}) or -1 for (N/A):",
                invalid_val: "Invalid value",
                reset_confirm: "Are you sure you want to reset all selections for this item?",
                cancel_confirm: "Are you sure you want to cancel and return to start? Unsaved data will be lost.",
                delete_draft_confirm: "Are you sure you want to delete the saved draft? This cannot be undone.",
                reset_scores_confirm: "Important Warning: All scores recorded so far will be deleted to allow modifying the max score.\n\nAre you sure you want to reset results?",
                error_items: "Must upload items file first",
                error_names: "Must upload names file first",
                error_max_score: "Max score must be between 1 and 10",
                file_error: "Error reading {type} file. Check file validity.",
                no_data: "No valid data found",
                item_label: "Item",
                domain_label: "Domain (Optional)",
                name_label: "Name",
                branch_label: "Branch (Optional)",
                lang_btn: "عربي",
                count_unit: "item",
                visible_items: "for visible items",
                report_date: "Date:",
                report_prep: "Prepared by:",
                report_title_default: "Evaluation Report",
                detailed_results_title: "Detailed Employee Evaluation Results",
                excellent: "Excellent",
                very_good: "Very Good",
                good: "Good",
                acceptable: "Acceptable",
                weak: "Weak"
            }
        };

        // --- الشاشة 1: الترحيب ---
        const WelcomeScreen = ({ onStart, t, toggleLang, lang }) => (
            <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-primary to-blue-900 text-white p-6 text-center">
                <div className="absolute top-4 right-4">
                    <button onClick={toggleLang} className="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-full flex items-center gap-2 backdrop-blur-sm transition">
                        <Icons.Languages /> {t('lang_btn')}
                    </button>
                </div>
                <div className="bg-white/10 backdrop-blur-md p-10 rounded-2xl shadow-2xl max-w-2xl border border-white/20 fade-in">
                    <h1 className="text-4xl font-extrabold mb-6 text-yellow-300 drop-shadow-md">{t('title')}</h1>
                    <p className="text-xl mb-8 leading-relaxed text-gray-100">
                        {t('welcome_desc').split('\n').map((line, i) => <React.Fragment key={i}>{line}<br/></React.Fragment>)}
                    </p>
                    <button 
                        onClick={onStart}
                        className="bg-yellow-500 hover:bg-yellow-600 text-blue-900 font-bold py-3 px-10 rounded-full text-xl shadow-lg transform transition hover:scale-105 active:scale-95"
                    >
                        {t('start')}
                    </button>
                    <p className="mt-8 text-xs text-gray-300 opacity-60">{t('dev_by')}</p>
                </div>
            </div>
        );

        // --- الشاشة 2: الإعداد (Main) ---
        const SetupScreen = ({ onComplete, config, setConfig, hasDraft, onLoadDraft, setHasDraft, isLocked, onResetScores, darkMode, toggleTheme, t, toggleLang }) => {
            const [helpOpen, setHelpOpen] = useState(false);
            const [error, setError] = useState(null);

            const handleResetScores = () => {
                if (confirm(t('reset_scores_confirm'))) {
                    onResetScores();
                }
            };

            const handleFileUpload = (e, type) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const wb = XLSX.read(bstr, { type: 'binary' });
                        const wsname = wb.SheetNames[0];
                        const ws = wb.Sheets[wsname];
                        const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
                        const processedData = SmartParser.cleanData(data, type);
                        
                        if (processedData.length === 0) throw new Error(t('no_data'));

                        if (type === 'names') setConfig({ ...config, names: processedData });
                        else setConfig({ ...config, items: processedData });
                        setError(null);
                    } catch (err) {
                        setError(t('file_error', { type: type === 'names' ? t('step2') : t('step1') }));
                    }
                };
                reader.readAsBinaryString(file);
            };

            const handleLogoUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    setConfig({ ...config, logo: evt.target.result });
                };
                reader.readAsDataURL(file);
            };
            
            const deleteDraft = () => {
                if(confirm(t('delete_draft_confirm'))) {
                    localStorage.removeItem('eval_draft');
                    setHasDraft(false);
                }
            };

            const validateAndStart = () => {
                if (config.items.length === 0) return setError(t('error_items'));
                if (config.names.length === 0) return setError(t('error_names'));
                if (config.maxScore < 1 || config.maxScore > 10) return setError(t('error_max_score'));
                onComplete();
            };

            return (
                <div className="min-h-screen bg-gray-50 dark:bg-gray-900 fade-in transition-colors duration-300">
                    <div className="bg-white dark:bg-gray-800 shadow-sm p-4 flex justify-between items-center border-b dark:border-gray-700">
                        <h2 className="text-xl font-bold text-primary dark:text-blue-400 flex items-center gap-2">
                            <Icons.Home /> {t('setup_title')}
                        </h2>
                        <div className="flex gap-2">
                            <button onClick={toggleLang} className="text-gray-500 hover:text-primary dark:text-gray-300 dark:hover:text-white flex items-center gap-1 text-sm font-bold">
                                <Icons.Languages className="w-4 h-4" /> {t('lang_btn')}
                            </button>
                            <button onClick={toggleTheme} className="text-gray-500 hover:text-primary dark:text-gray-300 dark:hover:text-white" title={darkMode ? "الوضع النهاري" : "الوضع الليلي"}>
                                {darkMode ? <Icons.Sun /> : <Icons.Moon />}
                            </button>
                            <button onClick={() => setHelpOpen(true)} className="text-gray-500 hover:text-primary dark:text-gray-300 dark:hover:text-white">
                                <Icons.Help />
                            </button>
                        </div>
                    </div>

                    <div className="container mx-auto p-6 max-w-4xl">
                        {hasDraft && (
                            <div className="bg-blue-50 border border-blue-200 p-4 mb-6 rounded-lg flex flex-wrap gap-4 justify-between items-center shadow-sm">
                                <span className="text-blue-800 font-bold">{t('draft_found')}</span>
                                <div className="flex gap-2">
                                    <button onClick={onLoadDraft} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center gap-2">
                                        <Icons.Download /> {t('restore_draft')}
                                    </button>
                                    <button onClick={deleteDraft} className="bg-red-100 text-red-700 px-4 py-2 rounded hover:bg-red-200 flex items-center gap-2 border border-red-200">
                                        <Icons.XCircle /> {t('delete_draft')}
                                    </button>
                                </div>
                            </div>
                        )}

                        {error && (
                            <div className="bg-red-100 border-r-4 border-red-500 text-red-700 p-4 mb-6 rounded shadow-sm flex items-center gap-2">
                                <Icons.Alert /> {error}
                            </div>
                        )}

                        <div className="grid md:grid-cols-2 gap-6">
                            {/* Step 1 */}
                            <div className={`p-6 rounded-xl border-2 transition-all ${config.items.length > 0 ? 'border-green-500 bg-green-50 dark:bg-green-900/20 dark:border-green-600' : 'border-dashed border-gray-300 bg-white dark:bg-gray-800 dark:border-gray-600'}`}>
                                <div className="flex justify-between items-start mb-4">
                                    <h3 className="font-bold text-lg text-gray-800 dark:text-gray-100">{t('step1')}</h3>
                                    {config.items.length > 0 && <Icons.Check />}
                                </div>
                                <div className="space-y-3">
                                    <label className="flex items-center justify-center w-full px-4 py-2 bg-blue-50 text-blue-700 rounded-lg cursor-pointer hover:bg-blue-100 border border-blue-200 transition">
                                        <Icons.Upload /> <span className="mx-2">{t('upload_excel')}</span>
                                        <input type="file" accept=".xlsx, .xls, .csv" className="hidden" onChange={(e) => handleFileUpload(e, 'items')} />
                                    </label>
                                    <p className="text-sm text-primary font-semibold mt-2 mb-1">{t('manual_entry')}</p>
                                    <DataEditorTable data={config.items} type="items" onChange={(newData) => setConfig({ ...config, items: newData })} t={t} />
                                </div>
                                <p className="text-xs text-gray-500 mt-2">{t('recognized_items', {count: config.items.length})}</p>
                            </div>

                            {/* Step 2 */}
                            <div className={`p-6 rounded-xl border-2 transition-all ${config.names.length > 0 ? 'border-green-500 bg-green-50 dark:bg-green-900/20 dark:border-green-600' : 'border-dashed border-gray-300 bg-white dark:bg-gray-800 dark:border-gray-600'}`}>
                                <div className="flex justify-between items-start mb-4">
                                    <h3 className="font-bold text-lg text-gray-800 dark:text-gray-100">{t('step2')}</h3>
                                    {config.names.length > 0 && <Icons.Check />}
                                </div>
                                <div className="space-y-3">
                                    <label className="flex items-center justify-center w-full px-4 py-2 bg-blue-50 text-blue-700 rounded-lg cursor-pointer hover:bg-blue-100 border border-blue-200 transition">
                                        <Icons.Upload /> <span className="mx-2">{t('upload_excel')}</span>
                                        <input type="file" accept=".xlsx, .xls, .csv" className="hidden" onChange={(e) => handleFileUpload(e, 'names')} />
                                    </label>
                                    <p className="text-sm text-primary font-semibold mt-2 mb-1">{t('manual_entry')}</p>
                                    <DataEditorTable data={config.names} type="names" onChange={(newData) => setConfig({ ...config, names: newData })} t={t} />
                                </div>
                                <p className="text-xs text-gray-500 mt-2">{t('recognized_names', {count: config.names.length})}</p>
                            </div>

                            {/* Step 3 */}
                            <div className="md:col-span-2 p-6 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                                <h3 className="font-bold text-lg text-gray-800 dark:text-gray-100 mb-4">{t('step3')}</h3>
                                <div className="flex items-center gap-4">
                                    <label className="text-gray-600 dark:text-gray-300">{t('max_score')}</label>
                                    <div className="relative">
                                        <input type="number" min="1" max="10" value={config.maxScore} onChange={(e) => setConfig({...config, maxScore: parseInt(e.target.value) || 0})} disabled={isLocked} className={`w-20 p-2 border rounded text-center font-bold text-primary focus:ring-2 focus:ring-primary ${isLocked ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : ''}`} />
                                        {isLocked && (
                                            <div className="absolute top-full mt-1 w-64 text-[10px] text-red-500 bg-red-50 p-1 rounded border border-red-100 shadow-sm z-10">لا يمكن التعديل لوجود نتائج مسجلة. لبدء تقييم جديد بمعايير مختلفة قم بتحديث الصفحة.</div>
                                        )}
                                    </div>
                                    {isLocked && (
                                        <button onClick={handleResetScores} className="bg-red-50 text-red-600 hover:bg-red-100 border border-red-200 px-3 py-2 rounded text-xs font-bold transition-colors flex items-center gap-1">
                                            <Icons.XCircle /> {t('reset_scores')}
                                        </button>
                                    )}
                                    {config.maxScore >= 1 && config.maxScore <= 10 && !isLocked && <Icons.Check />}
                                </div>
                            </div>

                            {/* Step 4: Report Info */}
                            <div className="md:col-span-2 p-6 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                                <h3 className="font-bold text-lg text-gray-800 dark:text-gray-100 mb-4">{t('step4')}</h3>
                                <div className="grid md:grid-cols-3 gap-4">
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">{t('org_name')}</label>
                                        <input type="text" value={config.orgName || ''} onChange={(e) => setConfig({...config, orgName: e.target.value})} className="w-full p-2 border rounded focus:ring-2 focus:ring-primary outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="مثال: مدرسة المجد" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-1">{t('evaluator_name')}</label>
                                        <input type="text" value={config.evaluatorName || ''} onChange={(e) => setConfig({...config, evaluatorName: e.target.value})} className="w-full p-2 border rounded focus:ring-2 focus:ring-primary outline-none" placeholder="مثال: أ. محمد أحمد" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-1">{t('logo')}</label>
                                        <input type="file" accept="image/*" onChange={handleLogoUpload} className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                                        {config.logo && <img src={config.logo} alt="Logo Preview" className="h-12 mt-2 object-contain border rounded p-1" />}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="mt-8 flex justify-center">
                            <button onClick={validateAndStart} className="bg-primary hover:bg-blue-800 text-white font-bold py-3 px-12 rounded-full shadow-lg text-lg flex items-center gap-3 transition-transform hover:scale-105">
                                <span>{t('start_eval')}</span> <Icons.Next />
                            </button>
                        </div>
                    </div>
                    <Modal isOpen={helpOpen} onClose={() => setHelpOpen(false)} title={t('help_guide')}>
                        <ul className="space-y-2 list-disc list-inside text-gray-700">
                            {t('help_text').split('\n').map((line, i) => <li key={i}>{line}</li>)}
                        </ul>
                    </Modal>
                    <Footer t={t} />
                </div>
            );
        };

        // --- الشاشة 3: التقييم الفعلي ---
        const EvaluationScreen = ({ config, onFinish, onSaveDraft, onCancel, onBackToSetup, initialScores, darkMode, toggleTheme, t, toggleLang }) => {
            const [currentIndex, setCurrentIndex] = useState(0);
            const [scores, setScores] = useState(initialScores || {}); 
            const [showMissing, setShowMissing] = useState(false);
            const [openNoteId, setOpenNoteId] = useState(null);
            const [showSaveHint, setShowSaveHint] = useState(false);
            const prevIndexRef = useRef(-1);
            const unsavedMoves = useRef(0);

            // عند تغيير الدرجات نقوم بتحديث الحالة للأب (اختياري لو أردنا حفظ لحظي)
            // ولكن سنعتمد على زر الحفظ اليدوي كما هو مطلوب

            const currentItem = config.items[currentIndex];
            const domains = useMemo(() => {
                const d = [];
                config.items.forEach(item => { if(!d.includes(item.sub)) d.push(item.sub); });
                return d;
            }, [config.items]);
            const currentDomainIndex = domains.indexOf(currentItem.sub);

            // إظهار تلميح الحفظ لمدة 3 ثواني عند الانتقال لبند جديد
            useEffect(() => {
                let timer;
                if (currentIndex > prevIndexRef.current) {
                    unsavedMoves.current += 1;
                    if (unsavedMoves.current >= 5) {
                        setShowSaveHint(true);
                        timer = setTimeout(() => setShowSaveHint(false), 3000);
                        unsavedMoves.current = 0;
                    }
                } else { setShowSaveHint(false); }
                prevIndexRef.current = currentIndex;
                return () => clearTimeout(timer);
            }, [currentIndex]);

            const handleScore = (nameId, val) => {
                setScores(prev => ({...prev, [`${currentItem.id}_${nameId}`]: val}));
            };

            const handleNote = (nameId, text) => {
                setScores(prev => ({...prev, [`note_${nameId}`]: text}));
            };

            const isAllRated = () => config.names.every(n => scores[`${currentItem.id}_${n.id}`] !== undefined);

            const handleNext = () => {
                if (!isAllRated()) { setShowMissing(true); window.scrollTo(0, 0); return; }
                setShowMissing(false);
                if (currentIndex < config.items.length - 1) { setCurrentIndex(prev => prev + 1); window.scrollTo(0, 0); }
                else { onFinish(scores); }
            };

            const handlePrev = () => { 
                if (currentIndex > 0) { 
                    setCurrentIndex(prev => prev - 1); window.scrollTo(0, 0); 
                } else {
                    onBackToSetup(); // العودة للإعدادات عند النقر في البند الأول
                }
            };
            const progress = config.items.length > 1 ? (currentIndex / (config.items.length - 1)) * 100 : 100;

            const saveDraft = () => {
                onSaveDraft(scores);
                unsavedMoves.current = 0;
                alert(t('save_draft') + " " + t('good'));
            };

            const handleResetCurrentItem = () => {
                if (confirm(t('reset_confirm'))) {
                    setScores(prev => {
                        const newScores = { ...prev };
                        config.names.forEach(person => {
                            delete newScores[`${currentItem.id}_${person.id}`];
                        });
                        return newScores;
                    });
                }
            };

            const handleApplyAll = () => {
                const input = prompt(t('apply_all_prompt', {max: config.maxScore}), config.maxScore);
                if (input === null) return;
                const val = parseInt(input);
                
                if (isNaN(val) || ((val < 1 || val > config.maxScore) && val !== -1)) {
                    alert(t('invalid_val'));
                    return;
                }

                setScores(prev => {
                    const newScores = { ...prev };
                    config.names.forEach(person => {
                        newScores[`${currentItem.id}_${person.id}`] = val;
                    });
                    return newScores;
                });
            };

            const cancelEval = () => {
                if(confirm(t('cancel_confirm'))) {
                    onCancel();
                }
            };

            return (
                <div className="min-h-screen bg-gray-50 dark:bg-gray-900 pb-20 fade-in transition-colors duration-300">
                    <div className="fixed top-0 left-0 w-full h-2 bg-gray-200 z-50">
                        <div className={`h-full transition-all duration-500 ${currentIndex === config.items.length - 1 ? 'bg-green-600' : 'bg-secondary'}`} style={{width: `${progress}%`}}></div>
                    </div>

                    {/* Header with Tools */}
                    <div className="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-40 border-b border-gray-200 dark:border-gray-700">
                        <div className="container mx-auto max-w-5xl p-4 flex justify-between items-center relative">
                            <div>
                                <div className="text-sm font-semibold text-accent uppercase tracking-wider">
                                    {t('domain')} {numberToText(currentDomainIndex)}: {currentItem.sub}
                                </div>
                                <h2 className="text-xl font-bold text-gray-800 dark:text-white">{currentIndex + 1}. {currentItem.main}</h2>
                            </div>
                            <div className="flex gap-2 items-center">
                                <button onClick={toggleLang} className="p-2 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600" title={t('lang_btn')}><Icons.Languages /></button>
                                <button onClick={toggleTheme} className="p-2 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600" title={darkMode ? "الوضع النهاري" : "الوضع الليلي"}>{darkMode ? <Icons.Sun /> : <Icons.Moon />}</button>
                                {showSaveHint && (
                                    <div className="hidden md:flex items-center gap-1 text-xs font-bold text-yellow-600 bg-yellow-50 px-2 py-1 rounded border border-yellow-200 fade-in transition-opacity duration-500">
                                        <span>{t('save_hint')}</span>
                                        <Icons.Next /> {/* سهم يشير لليسار (نحو زر الحفظ) */}
                                    </div>
                                )}
                                <button onClick={saveDraft} title={t('save_draft')} className="p-2 bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200"><Icons.Save /></button>
                                <button onClick={handleApplyAll} title={t('apply_all')} className="p-2 bg-purple-100 text-purple-700 rounded-full hover:bg-purple-200"><Icons.Wand /></button>
                                <button onClick={handleResetCurrentItem} title={t('reset_item')} className="p-2 bg-orange-100 text-orange-700 rounded-full hover:bg-orange-200"><Icons.Refresh /></button>
                                <button onClick={cancelEval} title={t('cancel_return')} className="p-2 bg-red-100 text-red-700 rounded-full hover:bg-red-200"><Icons.XCircle /></button>
                            </div>
                        </div>
                    </div>

                    <div className="container mx-auto max-w-5xl p-4 mt-4">
                        {showMissing && !isAllRated() && (
                            <div className="bg-red-50 text-red-600 p-3 rounded mb-4 text-center font-bold border border-red-200 animate-pulse">
                                {t('missing_alert')}
                            </div>
                        )}

                        <div className="bg-white dark:bg-gray-800 rounded-xl shadow overflow-hidden transition-colors duration-300">
                            {config.names.map((person) => {
                                const scoreKey = `${currentItem.id}_${person.id}`;
                                const currentScore = scores[scoreKey];
                                const isMissing = showMissing && currentScore === undefined;
                                const noteKey = `note_${person.id}`;
                                const currentNote = scores[noteKey] || '';

                                return (
                                    <div key={person.id} className={`border-b dark:border-gray-700 last:border-0 p-4 hover:bg-gray-50 dark:hover:bg-gray-700 transition ${isMissing ? 'bg-red-50 border-l-4 border-l-red-500' : ''}`}>
                                        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                            <div className="flex-1">
                                                <div className="flex items-center gap-2">
                                                    <h4 className="font-bold text-gray-800 dark:text-gray-100 text-lg">{person.main}</h4>
                                                    <button onClick={() => setOpenNoteId(openNoteId === person.id ? null : person.id)} className={`p-1 rounded-full ${currentNote ? 'bg-yellow-100 text-yellow-600' : 'text-gray-400 hover:text-gray-600'}`} title="إضافة ملاحظة">
                                                        <Icons.Message />
                                                    </button>
                                                </div>
                                                <span className="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full mt-1 inline-block">{person.sub}</span>
                                            </div>
                                            <div className="flex flex-wrap gap-1 justify-center md:justify-end">
                                                <button onClick={() => handleScore(person.id, -1)} className={`h-10 px-3 rounded-lg font-bold text-xs transition-all border ${currentScore === -1 ? 'bg-gray-600 text-white border-gray-600' : 'bg-gray-100 text-gray-500 border-gray-200 hover:bg-gray-200'}`}>{t('na')}</button>
                                                {Array.from({length: config.maxScore}, (_, i) => i + 1).map(val => (
                                                    <button key={val} onClick={() => handleScore(person.id, val)} className={`w-10 h-10 rounded-lg font-bold text-sm transition-all transform hover:scale-110 ${currentScore === val ? 'bg-primary text-white shadow-lg ring-2 ring-blue-300' : 'bg-white border border-gray-200 text-gray-600 hover:bg-gray-100'}`}>{val}</button>
                                                ))}
                                            </div>
                                        </div>
                                        {openNoteId === person.id && (
                                            <div className="mt-3 fade-in">
                                                <textarea 
                                                    value={currentNote}
                                                    onChange={(e) => handleNote(person.id, e.target.value)}
                                                    placeholder={t('note_placeholder')}
                                                    className="w-full p-2 border rounded-lg text-sm focus:ring-2 focus:ring-primary outline-none bg-yellow-50"
                                                    rows="2"
                                                ></textarea>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                        <div className="fixed bottom-0 left-0 w-full bg-white dark:bg-gray-800 p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-50 border-t dark:border-gray-700">
                            <div className="container mx-auto max-w-5xl flex justify-between items-center relative">
                                <button onClick={handlePrev} className={`flex items-center gap-2 px-8 py-3 rounded-full shadow-lg font-bold transition-transform active:scale-95 bg-gray-600 hover:bg-gray-700 text-white`}><Icons.Prev /> {currentIndex === 0 ? t('settings') : t('prev')}</button>
                                
                                {/* عداد البنود الجديد بتصميم عائم ومميز */}
                                <div className="absolute left-1/2 top-0 transform -translate-x-1/2 -translate-y-1/2 group cursor-default">
                                    <div className={`bg-gradient-to-br ${currentIndex === config.items.length - 1 ? 'from-green-600 to-green-800' : 'from-primary to-blue-700'} text-white w-20 h-20 rounded-full flex flex-col items-center justify-center shadow-xl border-[6px] border-gray-50 transition-transform group-hover:scale-110`}>
                                        <span className="text-2xl font-black leading-none drop-shadow-md">{currentIndex + 1}</span>
                                        <span className={`text-[10px] font-bold opacity-80 border-t ${currentIndex === config.items.length - 1 ? 'border-green-400' : 'border-blue-400'} w-8 text-center mt-1 pt-1`}>{t('of')} {config.items.length}</span>
                                    </div>
                                </div>

                                <button onClick={handleNext} className={`flex items-center gap-2 px-8 py-3 text-white rounded-full shadow-lg font-bold transition-transform active:scale-95 ${currentIndex === config.items.length - 1 ? 'bg-green-600 hover:bg-green-700' : 'bg-primary hover:bg-blue-800'}`}>{currentIndex === config.items.length - 1 ? t('finish') : t('next')} {currentIndex < config.items.length - 1 && <Icons.Next />}</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- مكون رأس التقرير ---
        const ReportHeader = ({ config, t }) => (
            <div className="flex justify-between items-center border-b-2 border-gray-800 pb-4 mb-6 w-full">
                <div>
                    <h1 className="text-2xl font-bold text-gray-900">{config.orgName || t('report_title_default')}</h1>
                    <p className="text-gray-600">{t('report_date')} {new Date().toLocaleDateString('ar-EG')}</p>
                </div>
                {config.logo && <img src={config.logo} alt="Logo" className="h-20 object-contain" />}
                <div className="text-left">
                    <p className="font-bold">{t('report_prep')} {config.evaluatorName || '-'}</p>
                </div>
            </div>
        );

        // --- مكون بطاقة الأداء الفردي (لإعادة الاستخدام) ---
        const SingleCard = ({ config, person, itemsByDomain, getCellColor, t, lang }) => (
            <div className="space-y-6 bg-white p-12 border border-gray-200 mx-auto" style={{ minHeight: '297mm', width: '210mm', boxSizing: 'border-box' }}>
                <ReportHeader config={config} t={t} />
                <div className="text-center border-b-2 border-gray-100 pb-4">
                    <h2 className="text-2xl font-bold text-primary mb-1">{person.main}</h2>
                    <p className="text-gray-500 font-semibold">{person.sub}</p>
                    <div className="flex justify-center gap-4 mt-4">
                        <div className="bg-blue-50 text-blue-800 px-4 py-2 rounded-lg text-center">
                            <span className="block text-xs text-blue-600">{t('general_percent')}</span>
                            <span className="font-bold text-xl">{person.percent.toFixed(1)}%</span>
                        </div>
                        <div className={`px-4 py-2 rounded-lg text-center ${getRating(person.percent, lang).class}`}>
                            <span className="block text-xs opacity-80">{t('rating')}</span>
                            <span className="font-bold text-xl">{getRating(person.percent, lang).label}</span>
                        </div>
                        <div className="bg-gray-50 text-gray-800 px-4 py-2 rounded-lg text-center">
                            <span className="block text-xs text-gray-500">{t('total_points')}</span>
                            <span className="font-bold text-xl">{person.totalScore}</span>
                        </div>
                    </div>
                </div>
                <div className="space-y-6">
                    {Object.entries(itemsByDomain).map(([domain, items]) => (
                        <div key={domain}>
                            <h3 className="font-bold text-accent border-r-4 border-accent pr-2 mb-3 bg-orange-50 py-1 rounded-l">{domain}</h3>
                            <div className="space-y-2 pr-2">
                                {items.map((item) => (
                                    <div key={item.id} className="flex justify-between items-center border-b border-gray-100 pb-2 last:border-0">
                                        <span className="text-gray-700 text-sm w-3/4">{item.main}</span>
                                        <span className={`font-bold px-3 py-1 rounded text-sm ${getCellColor(person.itemScores[item.id], config.maxScore)}`}>
                                            {person.itemScores[item.id] === -1 ? t('na') : person.itemScores[item.id]}
                                        </span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
                {person.note && (
                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mt-4">
                        <h4 className="font-bold text-yellow-800 mb-2 flex items-center gap-2"><Icons.Message /> {t('general_notes')}</h4>
                        <p className="text-gray-700 text-sm whitespace-pre-wrap">{person.note}</p>
                    </div>
                )}
            </div>
        );

        // --- 2الشاشة 4 & 5: النتائج والتحليل ---
        const ResultsAndAnalysis = ({ config, scores, onBackToEdit, onGoHome, darkMode, toggleTheme, t, toggleLang, lang }) => {
            const [view, setView] = useState('table'); // Default to analysis as requested for cards
            const [filterBranch, setFilterBranch] = useState(t('all'));
            const [filterDomain, setFilterDomain] = useState(t('all'));
            const [filterRating, setFilterRating] = useState(t('all'));
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedPerson, setSelectedPerson] = useState(null);
            const [isExporting, setIsExporting] = useState(false);
            const [showSummaries, setShowSummaries] = useState(false);

            
            // حساب النتائج
            const processedResults = useMemo(() => {
                return config.names.map(person => {
                    let totalScore = 0;
                    let validItemsCount = 0;
                    const itemScores = {};
                    config.items.forEach(item => {
                        let s = scores[`${item.id}_${person.id}`];
                        if (s === undefined) s = 0; // Fallback
                        itemScores[item.id] = s;
                        
                        if (s !== -1) {
                            totalScore += s;
                            validItemsCount++;
                        }
                    });
                    const note = scores[`note_${person.id}`] || '';
                    const maxPossible = validItemsCount * config.maxScore;
                    const percent = maxPossible > 0 ? (totalScore / maxPossible) * 100 : 0;
                    const average = validItemsCount > 0 ? totalScore / validItemsCount : 0;
                    return {
                        ...person, itemScores, totalScore,
                        percent, average, note
                    };
                });
            }, [config, scores]);

            const uniqueBranches = useMemo(() => {
                const branches = new Set(processedResults.map(p => p.sub));
                return [t('all'), ...Array.from(branches)];
            }, [processedResults, t]);

            // تحديد ما إذا كان يجب عرض عمود الفرع (يختفي إذا كان الكل "عام" أو لا يوجد تنوع)
            const showBranchColumn = useMemo(() => {
                const branches = new Set(processedResults.map(p => p.sub));
                if (branches.size > 1) return true;
                return !branches.has('عام');
            }, [processedResults]);

            const uniqueDomains = useMemo(() => {
                const domains = new Set(config.items.map(i => i.sub));
                return [t('all'), ...Array.from(domains)];
            }, [config.items, t]);

            const filteredResults = useMemo(() => {
                let res = processedResults;
                if (filterBranch !== t('all')) res = res.filter(p => p.sub === filterBranch);
                if (searchTerm) res = res.filter(p => p.main.toLowerCase().includes(searchTerm.toLowerCase()));
                if (filterRating !== t('all')) res = res.filter(p => getRating(p.percent, lang).label === filterRating);
                return res;
            }, [processedResults, filterBranch, searchTerm, filterRating, t, lang]);

            const aggregations = useMemo(() => {
                // الفروع
                const branches = {};
                filteredResults.forEach(p => {
                    if (!branches[p.sub]) branches[p.sub] = { total: 0, count: 0, name: p.sub };
                    branches[p.sub].total += p.percent;
                    branches[p.sub].count++;
                });
                const branchesArr = Object.values(branches).map(b => ({...b, percent: b.total/b.count}));

                // المجالات
                const domains = {};
                config.items.forEach(item => {
                    if(!domains[item.sub]) domains[item.sub] = { totalScore: 0, maxScore: 0, name: item.sub };
                    // الحساب بناءً على النتائج المفلترة فقط
                    filteredResults.forEach(p => {
                        const s = p.itemScores[item.id];
                        if (s !== -1 && s !== undefined) {
                            domains[item.sub].totalScore += s;
                            domains[item.sub].maxScore += config.maxScore;
                        }
                    });
                });
                const domainsArr = Object.values(domains).filter(d => d.maxScore > 0).map(d => ({...d, percent: (d.totalScore/d.maxScore)*100}));

                // البنود
                const items = config.items.map(item => {
                    let total = 0;
                    let validCount = 0;
                    filteredResults.forEach(p => {
                        const s = p.itemScores[item.id];
                        if (s !== -1 && s !== undefined) { total += s; validCount++; }
                    });
                    const maxPossible = validCount * config.maxScore;
                    return { ...item, total, percent: (total / maxPossible) * 100 };
                });

                return { branches: branchesArr, domains: domainsArr, items };
            }, [filteredResults, config]);

            // دالة للحصول على الأفضل والأسوأ
            const getMinMax = (arr) => {
                if(!arr || arr.length === 0) return {max:{name:'-', percent:0}, min:{name:'-', percent:0}};
                const max = arr.reduce((p, c) => (p.percent > c.percent ? p : c));
                const min = arr.reduce((p, c) => (p.percent < c.percent ? p : c));
                return { max, min };
            };

            const overallStats = useMemo(() => {
                const totalPercent = filteredResults.reduce((acc, curr) => acc + curr.percent, 0);
                const avgPercent = filteredResults.length ? totalPercent / filteredResults.length : 0;
                return { avgPercent };
            }, [filteredResults]);

            const kpi = {
                items: getMinMax(aggregations.items),
                domains: getMinMax(aggregations.domains),
                branches: getMinMax(aggregations.branches),
                names: getMinMax(filteredResults)
            };

            // إحصائيات الجدول السفلية
            const tableFooterStats = useMemo(() => {
                const itemsStats = config.items.map(item => {
                    // نحسب فقط القيم الصالحة (ليست -1)
                    const validScores = filteredResults.map(p => p.itemScores[item.id]).filter(s => s !== -1);
                    const total = validScores.reduce((sum, s) => sum + s, 0);
                    const count = validScores.length;
                    const maxPossible = count * config.maxScore;
                    
                    return { total, avg: count ? total / count : 0, percent: maxPossible > 0 ? (total / maxPossible) * 100 : 0 };
                });
                return { itemsStats };
            }, [config, filteredResults]);

            // الحفاظ على ترتيب البنود كما هي في ملف الإدخال (التقييم)
            const sortedItems = useMemo(() => {
                return config.items.map((item, index) => ({
                    ...item,
                    stat: tableFooterStats.itemsStats[index]
                }));
            }, [config.items, tableFooterStats]);

            // البنود الظاهرة بناء على تصفية المجال
            const visibleItems = useMemo(() => {
                if (filterDomain === t('all')) return sortedItems;
                return sortedItems.filter(i => i.sub === filterDomain);
            }, [sortedItems, filterDomain]);

            // هيكل أعمدة الجدول (بنود + فواصل المجاميع)
            const tableColumns = useMemo(() => {
                const cols = [];
                let currentDomain = null;
                visibleItems.forEach(item => {
                    if (showSummaries && currentDomain && item.sub !== currentDomain) {
                        cols.push({ type: 'summary', domain: currentDomain });
                    }
                    if (!currentDomain || item.sub !== currentDomain) currentDomain = item.sub;
                    cols.push({ type: 'item', data: item });
                });
                if (showSummaries && currentDomain) cols.push({ type: 'summary', domain: currentDomain });
                return cols;
            }, [visibleItems, showSummaries]);

            // تجميع البنود حسب المجال لبطاقة التقييم الفردي
            const itemsByDomain = useMemo(() => {
                const groups = {};
                config.items.forEach(item => {
                    if(!groups[item.sub]) groups[item.sub] = [];
                    groups[item.sub].push(item);
                });
                return groups;
            }, [config.items]);

            // التعامل مع وضع الطباعة للبطاقة
            useEffect(() => {
                if (selectedPerson) document.body.classList.add('print-mode-modal');
                else document.body.classList.remove('print-mode-modal');
            }, [selectedPerson]);

            // دالة التلوين الشرطي
            const getCellColor = (score, max) => {
                if (score === -1) return 'bg-gray-100 text-gray-500';
                const ratio = max > 0 ? score / max : 0;
                if (ratio === 1) return 'bg-green-100 text-green-800 font-bold';
                if (ratio >= 0.75) return 'bg-green-50 text-green-700';
                if (ratio >= 0.5) return 'bg-yellow-50 text-yellow-700';
                return 'bg-red-50 text-red-700 font-bold';
            };

            // إعداد خيارات المخططات المشتركة
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    datalabels: {
                        color: '#000',
                        anchor: 'end',
                        align: 'top',
                        formatter: (value) => Math.round(value) + '%',
                        font: { weight: 'bold' }
                    }
                },
                scales: {
                    y: { beginAtZero: true, max: 100 }
                }
            };
            // للمخطط الأفقي
            const horizontalOptions = {
                ...chartOptions,
                indexAxis: 'y',
                plugins: {
                    datalabels: {
                        color: '#000',
                        anchor: 'end',
                        align: 'end',
                        formatter: (value) => Math.round(value) + '%',
                        font: { weight: 'bold' }
                    }
                },
                scales: { x: { beginAtZero: true, max: 100 } }
            };


            useEffect(() => {
                if(view === 'analysis') {
                    // تنظيف
                    Chart.helpers.each(Chart.instances, (instance) => { instance.destroy(); });

                    const renderChart = (id, type, labels, data, label, color, options) => {
                        const ctx = document.getElementById(id);
                        if(ctx) {
                            new Chart(ctx, {
                                type: type,
                                data: {
                                    labels: labels,
                                    datasets: [{ label: label, data: data, backgroundColor: color, borderRadius: 5 }]
                                },
                                options: options
                            });
                        }
                    };

                    // ترتيب البيانات تنازلياً للمخططات
                    const sortedBranches = [...aggregations.branches].sort((a, b) => b.percent - a.percent);
                    const sortedDomains = [...aggregations.domains].sort((a, b) => b.percent - a.percent);
                    const sortedItemsChart = [...aggregations.items].sort((a, b) => b.percent - a.percent);
                    const sortedNamesChart = [...filteredResults].sort((a, b) => b.percent - a.percent);

                    // إعداد بيانات مخطط التقديرات
                    const ratingCounts = { 'ممتاز': 0, 'جيد جداً': 0, 'جيد': 0, 'مقبول': 0, 'ضعيف': 0 };
                    filteredResults.forEach(p => {
                        const r = getRating(p.percent, 'ar').label; // Keep internal logic in Arabic for now or map keys
                        if (ratingCounts[r] !== undefined) ratingCounts[r]++;
                    });
                    const ratingKeysAr = ['ممتاز', 'جيد جداً', 'جيد', 'مقبول', 'ضعيف'];
                    const ratingData = ratingKeysAr.map(k => ratingCounts[k]);
                    const ratingLabels = [t('excellent'), t('very_good'), t('good'), t('acceptable'), t('weak')];
                    const ratingColors = ['#10b981', '#3b82f6', '#06b6d4', '#f59e0b', '#ef4444'];

                    if (sortedBranches.length > 1) {
                        renderChart('chartBranch', 'bar', sortedBranches.map(b => b.name), sortedBranches.map(b => b.percent), t('chart_branch'), '#1e40af', chartOptions);
                    }
                    if (sortedDomains.length > 1) {
                        renderChart('chartDomain', 'bar', sortedDomains.map(d => d.name), sortedDomains.map(d => d.percent), t('chart_domain'), '#b45309', chartOptions);
                    }
                    renderChart('chartItems', 'bar', sortedItemsChart.map(i => i.main.substring(0, 50)+'...'), sortedItemsChart.map(i => i.percent), t('chart_items'), '#0f766e', horizontalOptions);
                    renderChart('chartNames', 'bar', sortedNamesChart.map(p => p.main), sortedNamesChart.map(p => p.percent), t('chart_names'), '#06b6d4', horizontalOptions);
                    renderChart('chartRating', 'doughnut', ratingLabels, ratingData, t('chart_rating'), ratingColors, { ...chartOptions, plugins: { ...chartOptions.plugins, legend: { position: 'right', labels: { font: { family: 'Cairo' } } } } });
                }
            }, [view, aggregations, processedResults, t, lang]);

            // تصدير Excel المتطور
            const exportToExcel = () => {
                const wb = XLSX.utils.book_new();
                
                // مصفوفة البيانات لتجميع الصفوف وحساب العرض
                const dataMatrix = [];

                // إعداد الأعمدة بناءً على هيكل الجدول (يشمل أعمدة التجميع)
                const domainRow = ['', ...(showBranchColumn ? [''] : []), ...tableColumns.map(col => col.type === 'summary' ? col.domain : col.data.sub), '', '', ''];
                const headerRow = [t('name_col'), ...(showBranchColumn ? [t('branch')] : []), ...tableColumns.map(col => col.type === 'summary' ? t('sum_domain', {domain: col.domain}) : col.data.main), t('total'), t('percent'), t('rating')];
                
                dataMatrix.push(domainRow, headerRow);

                let totalVisiblePercent = 0;

                const body = filteredResults.map(p => {
                    const dynamicCols = tableColumns.map(col => {
                        if (col.type === 'summary') {
                            const domainItems = visibleItems.filter(i => i.sub === col.domain);
                            return domainItems.reduce((acc, item) => acc + (p.itemScores[item.id] !== -1 ? p.itemScores[item.id] : 0), 0);
                        }
                        const val = p.itemScores[col.data.id];
                        return val === -1 ? t('na') : val;
                    });

                    // حساب المجموع والنسبة بناءً على الأعمدة الظاهرة
                    const visibleValidItems = visibleItems.filter(item => p.itemScores[item.id] !== -1);
                    const visibleMax = visibleValidItems.length * config.maxScore;
                    const visibleSum = visibleValidItems.reduce((sum, item) => sum + p.itemScores[item.id], 0);
                    const visiblePercent = visibleMax > 0 ? (visibleSum / visibleMax) * 100 : 0;
                    
                    totalVisiblePercent += visiblePercent;

                    return [p.main, ...(showBranchColumn ? [p.sub] : []), ...dynamicCols, visibleSum, visiblePercent.toFixed(1) + '%', getRating(visiblePercent, lang).label];
                });
                dataMatrix.push(...body);

                const avgVisiblePercent = filteredResults.length > 0 ? totalVisiblePercent / filteredResults.length : 0;

                // صفوف الإحصائيات
                const totalRowData = tableColumns.map(col => {
                    if (col.type === 'summary') {
                        const domainItems = visibleItems.filter(it => it.sub === col.domain);
                        return domainItems.reduce((acc, item) => acc + item.stat.total, 0);
                    }
                    return col.data.stat.total;
                });
                const totalRow = [t('total'), ...(showBranchColumn ? [''] : []), ...totalRowData, '', '', ''];

                const percentRowData = tableColumns.map(col => {
                    if (col.type === 'summary') return '-';
                    return col.data.stat.percent.toFixed(1) + '%';
                });
                const percentRow = [t('percent'), ...(showBranchColumn ? [''] : []), ...percentRowData, '', avgVisiblePercent.toFixed(1) + '%', '-'];
                
                dataMatrix.push(totalRow, percentRow);

                const ws = XLSX.utils.aoa_to_sheet(dataMatrix);
                
                // حساب عرض الأعمدة تلقائياً بناءً على المحتوى
                const colWidths = new Array(dataMatrix[0].length).fill(10);
                dataMatrix.forEach(row => {
                    row.forEach((cell, i) => {
                        const len = cell ? String(cell).length : 0;
                        // إضافة هامش بسيط وتحديد حد أقصى للعرض
                        if (len + 5 > colWidths[i]) {
                            colWidths[i] = Math.min(len + 5, 60);
                        }
                    });
                });

                ws['!cols'] = colWidths.map(w => ({ wch: w }));
                
                XLSX.utils.book_append_sheet(wb, ws, "النتائج");
                XLSX.writeFile(wb, "Evaluation_Detailed_Results.xlsx");
            };

            // تصدير الجدول فقط كـ PDF
            const exportTablePDF = async () => {
                setIsExporting(true);
                try {
                    const pdf = new window.jspdf.jsPDF('l', 'mm', 'a4');
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    const margin = 10;
                    const contentWidth = pageWidth - (margin * 2);

                    // Helper: Capture element to Image Data
                    const capture = async (element) => {
                        const canvas = await html2canvas(element, { scale: 2, useCORS: true, logging: false });
                        return {
                            data: canvas.toDataURL('image/png'),
                            width: contentWidth,
                            height: (canvas.height * contentWidth) / canvas.width,
                            canvas: canvas
                        };
                    };

                    // 1. Create Temp Container
                    const container = document.createElement('div');
                    Object.assign(container.style, {
                        position: 'absolute', left: '-9999px', top: '0',
                        width: '1400px',
                        backgroundColor: '#ffffff', direction: 'rtl', fontFamily: 'Cairo, sans-serif'
                    });
                    document.body.appendChild(container);

                    // 2. Prepare Sections
                    
                    // A. Top Section (Report Header + Title)
                    const topSection = document.createElement('div');
                    topSection.style.padding = '20px';
                    
                    const headerEl = document.getElementById('pdf-report-header');
                    if (headerEl) {
                        const headerClone = headerEl.cloneNode(true);
                        headerClone.classList.remove('hidden', 'print-only');
                        headerClone.style.display = 'block';
                        topSection.appendChild(headerClone);
                    }
                    
                    const titleEl = document.createElement('h2');
                    titleEl.innerText = t('detailed_results_title');
                    titleEl.className = 'text-2xl font-bold text-center mb-4 text-gray-800 border-b pb-2';
                    topSection.appendChild(titleEl);
                    container.appendChild(topSection);

                    // B. Table Header (Thead)
                    const originalTable = document.querySelector('#root table');
                    const tableForHead = originalTable.cloneNode(true);
                    tableForHead.querySelectorAll('.sticky').forEach(el => {
                        el.classList.remove('sticky', 'top-0', 'right-0', 'z-10', 'z-20', 'z-30');
                        el.style.position = 'static';
                    });
                    tableForHead.querySelector('tbody').style.display = 'none';
                    tableForHead.querySelector('tfoot').style.display = 'none';
                    tableForHead.style.width = '100%';
                    
                    const headContainer = document.createElement('div');
                    headContainer.style.padding = '0 20px';
                    headContainer.appendChild(tableForHead);
                    container.appendChild(headContainer);

                    // C. Table Body (Tbody + Tfoot)
                    const tableForBody = originalTable.cloneNode(true);
                    tableForBody.querySelectorAll('.sticky').forEach(el => {
                        el.classList.remove('sticky', 'top-0', 'right-0', 'z-10', 'z-20', 'z-30');
                        el.style.position = 'static';
                    });
                    tableForBody.querySelector('thead').style.display = 'none';
                    tableForBody.style.width = '100%';
                    
                    const bodyContainer = document.createElement('div');
                    bodyContainer.style.padding = '0 20px';
                    bodyContainer.appendChild(tableForBody);
                    container.appendChild(bodyContainer);

                    // D. Legend Table
                    const legendDiv = document.createElement('div');
                    legendDiv.className = 'mt-4 mx-5 p-4 border rounded bg-gray-50';
                    legendDiv.innerHTML = `
                        <h3 class="font-bold mb-2 text-sm text-gray-700">${t('items_legend')}</h3>
                        <div class="grid grid-cols-4 gap-2 text-[10px]">
                            ${config.items.map((item, i) => `
                                <div class="flex gap-1">
                                    <span class="font-bold text-primary bg-blue-50 px-1 rounded border border-blue-100">${i + 1}</span>
                                    <span class="truncate" title="${item.main}">${item.main}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    container.appendChild(legendDiv);

                    // E. Footer Credit
                    const footerDiv = document.createElement('div');
                    footerDiv.className = 'text-center text-gray-500 text-xs font-bold mt-2 p-2 border-t border-gray-400';
                    footerDiv.innerText = t('dev_by');
                    container.appendChild(footerDiv);

                    // 3. Capture Images
                    const imgTop = await capture(topSection);
                    const imgHead = await capture(headContainer);
                    const imgBody = await capture(bodyContainer);
                    const imgLegend = await capture(legendDiv);
                    const imgFooter = await capture(footerDiv);

                    // 4. Generate PDF
                    let pageNum = 1;
                    let renderedBodyH = 0;
                    const totalBodyH = imgBody.height;
                    const bodyCanvas = imgBody.canvas;

                    while (renderedBodyH < totalBodyH) {
                        let cursorY = margin;

                        // Add Top Section (Only Page 1)
                        if (pageNum === 1) {
                            pdf.addImage(imgTop.data, 'PNG', margin, cursorY, imgTop.width, imgTop.height);
                            cursorY += imgTop.height;
                        }

                        // Add Table Header (Every Page)
                        pdf.addImage(imgHead.data, 'PNG', margin, cursorY, imgHead.width, imgHead.height);
                        cursorY += imgHead.height;

                        // Calculate Available Space
                        const footerSpace = imgFooter.height + 10;
                        const availableH = pageHeight - margin - footerSpace - cursorY;

                        // Determine Slice
                        let remainingH = totalBodyH - renderedBodyH;
                        let sliceH_PDF = Math.min(remainingH, availableH);

                        // Slice Canvas
                        const ratio = bodyCanvas.width / contentWidth;
                        const sliceH_PX = sliceH_PDF * ratio;
                        const srcY_PX = renderedBodyH * ratio;

                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = bodyCanvas.width;
                        tempCanvas.height = sliceH_PX;
                        const ctx = tempCanvas.getContext('2d');
                        ctx.drawImage(bodyCanvas, 0, srcY_PX, bodyCanvas.width, sliceH_PX, 0, 0, bodyCanvas.width, sliceH_PX);
                        
                        const sliceData = tempCanvas.toDataURL('image/png');
                        pdf.addImage(sliceData, 'PNG', margin, cursorY, contentWidth, sliceH_PDF);
                        cursorY += sliceH_PDF;
                        renderedBodyH += sliceH_PDF;

                        // Add Footer Credit
                        pdf.addImage(imgFooter.data, 'PNG', margin, pageHeight - margin - imgFooter.height - 5, imgFooter.width, imgFooter.height);
                        
                        // Check for Legend
                        if (renderedBodyH >= totalBodyH) {
                            if (pageHeight - margin - footerSpace - cursorY > imgLegend.height + 5) {
                                pdf.addImage(imgLegend.data, 'PNG', margin, cursorY + 5, imgLegend.width, imgLegend.height);
                            } else {
                                pdf.addPage();
                                pageNum++;
                                cursorY = margin;
                                pdf.addImage(imgHead.data, 'PNG', margin, cursorY, imgHead.width, imgHead.height);
                                cursorY += imgHead.height;
                                pdf.addImage(imgLegend.data, 'PNG', margin, cursorY + 5, imgLegend.width, imgLegend.height);
                                
                                pdf.addImage(imgFooter.data, 'PNG', margin, pageHeight - margin - imgFooter.height - 5, imgFooter.width, imgFooter.height);
                            }
                        } else {
                            pdf.addPage();
                            pageNum++;
                        }
                    }

                    // Add Page Numbers (Current / Total) at Bottom Left
                    const totalPages = pdf.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        pdf.setPage(i);
                        pdf.setFontSize(9);
                        pdf.setTextColor(100);
                        pdf.text(`${i} / ${totalPages}`, margin, pageHeight - margin, { align: lang === 'ar' ? 'left' : 'right' });
                    }

                    pdf.save('Detailed_Results_Evaluation.pdf');
                    document.body.removeChild(container);
                } catch (err) {
                    console.error(err);
                    alert("حدث خطأ أثناء تصدير PDF: " + err.message);
                }
                setIsExporting(false);
            };

            const exportPDFReports = async () => {
                setIsExporting(true);
                try {
                    const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const margin = 10;
                    const contentWidth = pdfWidth - (margin * 2);

                    // إعداد صورة التذييل (Footer)
                    const footerDiv = document.createElement('div');
                    Object.assign(footerDiv.style, {
                        position: 'absolute', left: '-9999px', top: '0',
                        width: `${contentWidth}mm`, textAlign: 'center',
                        color: '#6b7280', fontSize: '12px', fontWeight: 'bold', fontFamily: 'Cairo, sans-serif',
                        padding: '10px', lineHeight: '1.5',
                        borderTop: '1px solid #9ca3af'
                    });
                    footerDiv.innerText = t('dev_by');
                    document.body.appendChild(footerDiv);
                    const footerCanvas = await html2canvas(footerDiv, { scale: 2 });
                    const footerImg = footerCanvas.toDataURL('image/png');
                    const footerH = (footerCanvas.height * contentWidth) / footerCanvas.width;
                    document.body.removeChild(footerDiv);

                    // إنشاء حاوية مخفية لالتقاط الترويسة
                    const offScreenContainer = document.createElement('div');
                    Object.assign(offScreenContainer.style, {
                        position: 'absolute', left: '-9999px', top: '0', 
                        width: `${contentWidth}mm`, 
                        background: '#fff',
                        direction: 'rtl'
                    });
                    document.body.appendChild(offScreenContainer);

                    // التقاط الترويسة (Header)
                    const headerEl = document.getElementById('pdf-report-header');
                    let headerImg = null;
                    let headerHeight = 0;
                    
                    if (headerEl) {
                        const headerClone = headerEl.cloneNode(true);
                        headerClone.classList.remove('hidden', 'print-only');
                        headerClone.style.display = 'block';
                        headerClone.style.padding = '10px';
                        offScreenContainer.appendChild(headerClone);
                        
                        const headerCanvas = await html2canvas(headerClone, { scale: 3, useCORS: true });
                        headerImg = headerCanvas.toDataURL('image/png');
                        headerHeight = (headerCanvas.height * contentWidth) / headerCanvas.width;
                        offScreenContainer.innerHTML = ''; 
                    }

                    const addHeaderToPage = () => {
                        if (headerImg) {
                            pdf.addImage(headerImg, 'PNG', margin, margin, contentWidth, headerHeight);
                            return margin + headerHeight + 10;
                        }
                        return margin;
                    };

                    const addSection = async (id, yPos, isKpi = false, fillPage = false) => {
                        const el = document.getElementById(id);
                        if (!el) return yPos;
                        
                        const clone = el.cloneNode(true);
                        
                        // إصلاح مشكلة اختفاء المخططات: تحويل الـ Canvas إلى صورة في النسخة
                        const originalCanvases = el.querySelectorAll('canvas');
                        const clonedCanvases = clone.querySelectorAll('canvas');
                        
                        if (originalCanvases.length > 0) {
                            originalCanvases.forEach((orig, i) => {
                                const dest = clonedCanvases[i];
                                if (dest) {
                                    const img = document.createElement('img');
                                    img.src = orig.toDataURL();
                                    img.style.width = '100%';
                                    img.style.height = 'auto';
                                    img.style.height = '100%';
                                    img.style.objectFit = 'contain';
                                    img.className = dest.className;
                                    dest.parentNode.replaceChild(img, dest);
                                }
                            });
                        }

                        // تحسينات خاصة بقسم البطاقات لملء الصفحة والوضوح
                        if (isKpi) {
                            const cards = clone.querySelectorAll('div > div'); 
                            cards.forEach(card => {
                                card.style.border = '1px solid #ccc';
                            });
                        }

                        if (fillPage) {
                            clone.style.height = 'auto';
                            clone.classList.remove('h-[800px]', 'h-80');
                        }

                        offScreenContainer.appendChild(clone);

                        const scale = 2;
                        const canvas = await html2canvas(clone, { scale: scale, useCORS: true });
                        const imgData = canvas.toDataURL('image/png');
                        
                        offScreenContainer.innerHTML = '';
                        
                        if (fillPage) {
                            pdf.addPage();
                            yPos = addHeaderToPage();
                            const availableHeight = pdfHeight - yPos - margin;
                            pdf.addImage(imgData, 'PNG', margin, yPos, contentWidth, availableHeight);
                            return pdfHeight;
                        } else {
                            const imgHeight = (canvas.height * contentWidth) / canvas.width;
                            if (yPos + imgHeight > pdfHeight - margin) {
                                pdf.addPage();
                                yPos = addHeaderToPage();
                            }
                            pdf.addImage(imgData, 'PNG', margin, yPos, contentWidth, imgHeight);
                            return yPos + imgHeight + 10;
                        }
                    };

                    // الصفحة 1: البطاقات (KPIs)
                    let currentY = addHeaderToPage();
                    currentY = await addSection('kpi-section', currentY, true, false);

                    // الصفحة 2: مخططات الفروع والمجالات
                    if (document.getElementById('chart-branch-container') || document.getElementById('chart-domain-container')) {
                        pdf.addPage();
                        currentY = addHeaderToPage();
                        currentY = await addSection('chart-branch-container', currentY, false, false);
                        currentY = await addSection('chart-domain-container', currentY, false, false);
                        currentY = await addSection('chart-rating-container', currentY, false, false);
                    }

                    // الصفحة 3: مقارنة الأسماء
                    if (document.getElementById('chart-names-container')) {
                        await addSection('chart-names-container', 0, false, true);
                    }

                    // الصفحة 4: تحليل البنود
                    if (document.getElementById('chart-items-container')) {
                        await addSection('chart-items-container', 0, false, true);
                    }
                    
                    // إضافة التذييل وأرقام الصفحات لجميع الصفحات
                    const totalPages = pdf.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        pdf.setPage(i);
                        pdf.addImage(footerImg, 'PNG', margin, pdfHeight - margin - footerH, contentWidth, footerH);
                        pdf.setFontSize(9);
                        pdf.setTextColor(100);
                        pdf.text(`${i} / ${totalPages}`, margin, pdfHeight - margin, { align: lang === 'ar' ? 'left' : 'right' });
                    }

                    pdf.save(`Analysis_Report_${new Date().toLocaleDateString('en-GB').replace(/\//g, '-')}.pdf`);
                    document.body.removeChild(offScreenContainer);
                } catch (err) {
                    console.error(err);
                    alert("حدث خطأ أثناء التصدير: " + err.message);
                }
                setIsExporting(false);
            };

            const exportCardPDF = async () => {
                const element = document.getElementById('printable-card');
                
                // إنشاء حاوية مؤقتة خارج الشاشة لضمان التقاط البطاقة كاملة وبأبعاد صحيحة
                const container = document.createElement('div');
                container.style.position = 'absolute';
                container.style.left = '-9999px';
                container.style.top = '0';
                container.style.width = 'fit-content';
                document.body.appendChild(container);

                const clone = element.cloneNode(true);
                container.appendChild(clone);

                try {
                    // نستخدم الكانفاس مباشرة للتقطيع بدلاً من تحويله لصورة فوراً
                    const canvas = await html2canvas(clone, { scale: 2, useCORS: true, logging: false });
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
                    
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    
                    // إعدادات الهوامش (تم توحيدها مع التصدير الجماعي)
                    // إعدادات الهوامش الدقيقة
                    const xMargin = 10;
                    const yMargin = 30; // زيادة الهوامش العلوية والسفلية لمنع القص
                    
                    const topMargin = 20; // الهامش العلوي
                    const bottomMargin = 20; // الهامش السفلي (للتذييل)
                    const contentWidth = pdfWidth - (xMargin * 2);
                    const contentHeight = pdfHeight - topMargin - bottomMargin; // المساحة المتاحة للمحتوى فقط

                    // إعداد صورة التذييل
                    const footerDiv = document.createElement('div');
                    Object.assign(footerDiv.style, {
                        position: 'absolute', left: '-9999px', top: '0',
                        width: `${contentWidth}mm`, textAlign: 'center',
                        color: '#6b7280', fontSize: '12px', fontWeight: 'bold', fontFamily: 'Cairo, sans-serif',
                        padding: '10px', lineHeight: '1.5',
                        borderTop: '1px solid #9ca3af'
                    });
                    footerDiv.innerText = t('dev_by');
                    document.body.appendChild(footerDiv);
                    const footerCanvas = await html2canvas(footerDiv, { scale: 2 });
                    const footerImg = footerCanvas.toDataURL('image/png');
                    const footerH = (footerCanvas.height * contentWidth) / footerCanvas.width;
                    document.body.removeChild(footerDiv);
                    
                    // منطق التقطيع (Slicing Logic)
                    const totalCanvasHeight = canvas.height;
                    // ارتفاع الصفحة الواحدة بمقياس الكانفاس
                    const canvasPageHeight = (contentHeight * canvas.width) / contentWidth;
                    
                    let renderedHeight = 0;

                    while (renderedHeight < totalCanvasHeight) {
                        if (renderedHeight > 0) pdf.addPage();

                        // تحديد ارتفاع الجزء المراد قصه
                        const currentSliceHeight = Math.min(canvasPageHeight, totalCanvasHeight - renderedHeight);

                        // إنشاء كانفاس مؤقت للجزء المقصوص
                        const sliceCanvas = document.createElement('canvas');
                        sliceCanvas.width = canvas.width;
                        sliceCanvas.height = currentSliceHeight;
                        const ctx = sliceCanvas.getContext('2d');
                        
                        // رسم الجزء المحدد فقط
                        ctx.drawImage(canvas, 0, renderedHeight, canvas.width, currentSliceHeight, 0, 0, canvas.width, currentSliceHeight);
                        const sliceImgData = sliceCanvas.toDataURL('image/png');
                        
                        // حساب الارتفاع في ملف PDF
                        const pdfSliceHeight = (currentSliceHeight * contentWidth) / canvas.width;

                        // إضافة الصورة في المكان المحدد (تحت الهامش العلوي)
                        pdf.addImage(sliceImgData, 'PNG', xMargin, topMargin, contentWidth, pdfSliceHeight);
                        
                        // إضافة التذييل في كل صفحة
                        pdf.addImage(footerImg, 'PNG', xMargin, pdfHeight - 15 - footerH, contentWidth, footerH);

                        renderedHeight += currentSliceHeight;
                    }

                    // إضافة التذييل وأرقام الصفحات
                    // إضافة أرقام الصفحات في النهاية
                    const totalPages = pdf.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        pdf.setPage(i);
                        pdf.addImage(footerImg, 'PNG', xMargin, pdfHeight - 15 - footerH, contentWidth, footerH); 
                        pdf.setFontSize(9);
                        pdf.setTextColor(100);
                        pdf.text(`${i} / ${totalPages}`, xMargin, pdfHeight - 15, { align: lang === 'ar' ? 'left' : 'right' });
                    }

                    pdf.save(`${selectedPerson.main}_card.pdf`);
                    
                    // تنظيف الحاوية المؤقتة
                    document.body.removeChild(container);
                } catch (err) {
                    console.error(err);
                    alert("حدث خطأ أثناء تصدير البطاقة");
                }
            };

            const handleExportAllCards = async () => {
                if (!confirm(`سيتم تصدير ${filteredResults.length} بطاقة في ملف واحد. قد تستغرق العملية بضع ثوانٍ. هل تريد المتابعة؟`)) return;
                
                setIsExporting(true);
                // انتظار التصيير (Rendering)
                setTimeout(async () => {
                    try {
                        const doc = new window.jspdf.jsPDF('p', 'mm', 'a4');
                        const pageWidth = doc.internal.pageSize.getWidth();
                        const pageHeight = doc.internal.pageSize.getHeight();
                        
                        // إعدادات الهوامش
                        const xMargin = 10;
                        const yMargin = 30; // زيادة الهوامش العلوية والسفلية لمنع القص
                        const topMargin = 20;
                        const bottomMargin = 20;
                        const contentWidth = pageWidth - (xMargin * 2);
                        const contentHeight = pageHeight - topMargin - bottomMargin;

                        // إعداد صورة التذييل
                        const footerDiv = document.createElement('div');
                        Object.assign(footerDiv.style, {
                            position: 'absolute', left: '-9999px', top: '0',
                            width: `${contentWidth}mm`, textAlign: 'center',
                            color: '#6b7280', fontSize: '12px', fontWeight: 'bold', fontFamily: 'Cairo, sans-serif',
                            padding: '10px', lineHeight: '1.5',
                            borderTop: '1px solid #9ca3af'
                        });
                        footerDiv.innerText = t('dev_by');
                        document.body.appendChild(footerDiv);
                        const footerCanvas = await html2canvas(footerDiv, { scale: 2 });
                        const footerImg = footerCanvas.toDataURL('image/png');
                        const footerH = (footerCanvas.height * contentWidth) / footerCanvas.width;
                        document.body.removeChild(footerDiv);

                        const cards = document.querySelectorAll('.bulk-card-item > div');
                        
                        let isFirstPage = true;

                        for (let i = 0; i < cards.length; i++) {
                            const card = cards[i];
                            const canvas = await html2canvas(card, { scale: 2, useCORS: true, logging: false });
                            const imgData = canvas.toDataURL('image/png');
                            
                            // إضافة صفحة جديدة لكل شخص (ما عدا الأول)
                            if (i > 0) doc.addPage();
                            
                            const totalCanvasHeight = canvas.height;
                            const canvasPageHeight = (contentHeight * canvas.width) / contentWidth;
                            let renderedHeight = 0;

                            while (renderedHeight < totalCanvasHeight) {
                                if (renderedHeight > 0) doc.addPage();

                                const currentSliceHeight = Math.min(canvasPageHeight, totalCanvasHeight - renderedHeight);

                                const sliceCanvas = document.createElement('canvas');
                                sliceCanvas.width = canvas.width;
                                sliceCanvas.height = currentSliceHeight;
                                const ctx = sliceCanvas.getContext('2d');
                                ctx.drawImage(canvas, 0, renderedHeight, canvas.width, currentSliceHeight, 0, 0, canvas.width, currentSliceHeight);
                                
                                const sliceImgData = sliceCanvas.toDataURL('image/png');
                                const pdfSliceHeight = (currentSliceHeight * contentWidth) / canvas.width;

                                doc.addImage(sliceImgData, 'PNG', xMargin, topMargin, contentWidth, pdfSliceHeight);
                                
                                // إضافة التذييل
                                doc.addImage(footerImg, 'PNG', xMargin, pageHeight - 15 - footerH, contentWidth, footerH);

                                renderedHeight += currentSliceHeight;
                            }
                        }

                        // إضافة التذييل وأرقام الصفحات
                        // إضافة أرقام الصفحات
                        const totalPages = doc.getNumberOfPages();
                        for (let i = 1; i <= totalPages; i++) {
                            doc.setPage(i);
                            doc.addImage(footerImg, 'PNG', xMargin, pageHeight - 15 - footerH, contentWidth, footerH);
                            doc.setFontSize(9);
                            doc.setTextColor(100);
                            doc.text(`${i} / ${totalPages}`, xMargin, pageHeight - 15, { align: lang === 'ar' ? 'left' : 'right' });
                        }
                        
                        doc.save(`All_Cards_${new Date().toLocaleDateString('en-GB').replace(/\//g, '-')}.pdf`);
                    } catch (err) {
                        console.error(err);
                        alert("حدث خطأ أثناء التصدير: " + err.message);
                    }
                    setIsExporting(false);
                }, 1000);
            };

            const KPICard = ({ title, bestName, bestScore, worstName, worstScore, color, iconName }) => (
                <div className={`bg-white rounded-lg shadow-md p-4 border-r-4 border-${color}-600 relative overflow-hidden`}>
                    <div className="relative z-10">
                        <h4 className="font-bold text-gray-700 mb-2 border-b pb-1">{title}</h4>
                        <div className="grid grid-cols-2 gap-2 text-sm">
                        <div className="bg-green-50 p-2 rounded">
                            <span className="block text-green-700 font-bold text-xs">{t('best')}</span>
                            <div className="font-bold truncate" title={bestName}>{bestName}</div>
                            <div className="text-green-600 font-bold">{bestScore.toFixed(1)}%</div>
                        </div>
                        <div className="bg-red-50 p-2 rounded">
                            <span className="block text-red-700 font-bold text-xs">{t('worst')}</span>
                            <div className="font-bold truncate" title={worstName}>{worstName}</div>
                            <div className="text-red-600 font-bold">{worstScore.toFixed(1)}%</div>
                        </div>
                    </div>
                    </div>
                    {iconName && (
                        <div className={`absolute -left-6 -bottom-6 text-${color}-100 opacity-50 pointer-events-none`}>
                            <LucideIcon name={iconName} className="w-32 h-32" />
                        </div>
                    )}
                </div>
            );

            return (
                <div className="min-h-screen bg-gray-50 dark:bg-gray-900 fade-in transition-colors duration-300">
                    <div className="shadow border-b no-print sticky top-0 z-30 bg-white dark:bg-gray-800 dark:border-gray-700">
                        {/* Navigation Row */}
                        <div className="p-3">
                            <div className="container mx-auto flex flex-wrap justify-between items-center gap-4">
                                <h2 className="text-2xl font-bold text-gray-800 dark:text-white">
                                    {view === 'table' ? t('results_title') : t('analysis_title')}
                                </h2>
                                <div className="flex gap-2">
                                    <button onClick={() => setView('table')} className={`px-4 py-2 rounded ${view === 'table' ? 'bg-primary text-white' : 'bg-gray-200'}`}>{t('table_view')}</button>
                                    <button onClick={() => setView('analysis')} className={`px-4 py-2 rounded ${view === 'analysis' ? 'bg-primary text-white' : 'bg-gray-200'}`}>{t('analysis_view')}</button>
                                    <div className="w-px h-8 bg-gray-300 mx-1"></div>
                                    <button onClick={toggleLang} className="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 px-3 py-2 rounded hover:bg-gray-300 dark:hover:bg-gray-600 flex items-center gap-1" title={t('lang_btn')}><Icons.Languages /></button>
                                    <button onClick={toggleTheme} className="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 px-3 py-2 rounded hover:bg-gray-300 dark:hover:bg-gray-600 flex items-center gap-1" title={darkMode ? "الوضع النهاري" : "الوضع الليلي"}>{darkMode ? <Icons.Sun /> : <Icons.Moon />}</button>
                                    <button onClick={onBackToEdit} className="bg-yellow-500 text-white px-3 py-2 rounded hover:bg-yellow-600 flex items-center gap-1"><Icons.Edit/> {t('edit_eval')}</button>
                                    <button onClick={onGoHome} className="bg-gray-600 text-white px-3 py-2 rounded hover:bg-gray-700 flex items-center gap-1" title={t('home')}><Icons.Home/> {t('home')}</button>
                                </div>
                            </div>
                        </div>
                        
                        {/* Export Row */}
                        <div className="bg-blue-50 dark:bg-blue-900/30 p-3 border-t border-blue-100 dark:border-blue-800">
                            <div className="container mx-auto flex flex-wrap items-center gap-3">
                                <span className="text-sm font-bold text-gray-500 dark:text-gray-300 ml-2">{t('export_options')}</span>
                                {view === 'table' ? (
                                    <>
                                        <button onClick={exportToExcel} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex items-center gap-2 text-sm font-bold shadow-sm"><Icons.File/> {t('export_excel')}</button>
                                        <button onClick={exportTablePDF} disabled={isExporting} className={`bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 flex items-center gap-2 text-sm font-bold shadow-sm ${isExporting ? 'opacity-50 cursor-wait' : ''}`}><Icons.File/> {t('export_pdf_table')}</button>
                                        <button onClick={handleExportAllCards} disabled={isExporting} className={`text-white px-4 py-2 rounded shadow-sm flex items-center gap-2 text-sm font-bold transition-all ${isExporting ? 'bg-gray-400 cursor-wait' : 'bg-indigo-600 hover:bg-indigo-700'}`}>
                                            {isExporting ? 'جاري المعالجة...' : <><Icons.Download/> {t('export_cards')}</>}
                                        </button>
                                    </>
                                ) : (
                                    <button onClick={exportPDFReports} disabled={isExporting} className={`bg-gray-800 text-white px-4 py-2 rounded hover:bg-gray-900 flex items-center gap-2 text-sm font-bold shadow-sm ${isExporting ? 'opacity-50 cursor-wait' : ''}`}><Icons.Download/> {t('export_report')}</button>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="container mx-auto p-6 max-w-7xl">
                        {/* رأس التقرير للطباعة العامة */}
                        <div id="pdf-report-header" className="hidden print-only mb-4"><ReportHeader config={config} t={t} /></div>
                        {view === 'table' ? (
                            <div className="space-y-4">
                                {/* شريط التصفية المستقل */}
                                <div className="bg-white dark:bg-gray-800 p-3 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 flex flex-wrap gap-4 items-center no-print">
                                    <span className="text-gray-500 font-bold text-sm flex items-center gap-1"><Icons.Alert /> {t('filter_search')}</span>
                                    
                                    <div className="flex items-center gap-2 border-l pl-4 ml-2">
                                        <Icons.Search className="text-gray-400 w-4 h-4" />
                                        <input 
                                            type="text" 
                                            placeholder={t('search_placeholder')}
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                            className="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded focus:ring-primary focus:border-primary p-1.5 w-48"
                                        />
                                        {searchTerm && (
                                            <button onClick={() => setSearchTerm('')} className="text-gray-400 hover:text-red-500 transition-colors" title="إلغاء البحث">
                                                <Icons.XCircle />
                                            </button>
                                        )}
                                    </div>

                                    {uniqueBranches.length > 2 && (
                                            <div className="flex items-center gap-2">
                                                <label className="text-xs font-bold text-gray-600">{t('branch')}:</label>
                                                <select value={filterBranch} onChange={(e) => setFilterBranch(e.target.value)} className="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded focus:ring-primary focus:border-primary p-1.5">
                                                    {uniqueBranches.map(b => <option key={b} value={b}>{b}</option>)}
                                                </select>
                                            </div>
                                        )}

                                        {uniqueDomains.length > 2 && (
                                            <div className="flex items-center gap-2 border-r pr-4 mr-2">
                                                <label className="text-xs font-bold text-gray-600">{t('domain')}:</label>
                                                <select value={filterDomain} onChange={(e) => setFilterDomain(e.target.value)} className="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded focus:ring-primary focus:border-primary p-1.5">
                                                    {uniqueDomains.map(d => <option key={d} value={d}>{d}</option>)}
                                                </select>
                                            </div>
                                        )}

                                        <div className="flex items-center gap-2 border-r pr-4 mr-2">
                                            <label className="text-xs font-bold text-gray-600">{t('rating')}:</label>
                                            <select value={filterRating} onChange={(e) => setFilterRating(e.target.value)} className="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded focus:ring-primary focus:border-primary p-1.5">
                                                <option value={t('all')}>{t('all')}</option>
                                                {[t('excellent'), t('very_good'), t('good'), t('acceptable'), t('weak')].map(r => <option key={r} value={r}>{r}</option>)}
                                            </select>
                                        </div>

                                        {(filterBranch !== t('all') || filterDomain !== t('all') || filterRating !== t('all')) && (
                                            <button onClick={() => { setFilterBranch(t('all')); setFilterDomain(t('all')); setFilterRating(t('all')); }} className="text-red-500 hover:text-red-700 text-xs font-bold flex items-center gap-1 bg-red-50 px-2 py-1 rounded border border-red-200 transition-colors">
                                                <Icons.XCircle /> {t('cancel_filter')}
                                            </button>
                                        )}

                                        <button onClick={() => setShowSummaries(!showSummaries)} className={`text-xs font-bold px-3 py-1.5 rounded border transition-colors flex items-center gap-1 ${lang === 'ar' ? 'mr-auto' : 'ml-auto'} ${showSummaries ? 'bg-blue-100 text-blue-700 border-blue-300' : 'bg-gray-50 text-gray-600 border-gray-300 hover:bg-gray-100'}`}>
                                            <Icons.File /> {showSummaries ? t('hide_sums') : t('show_sums')}
                                        </button>
                                    </div>

                                <div className="bg-white dark:bg-gray-800 rounded-lg shadow overflow-x-auto max-h-[75vh] overflow-y-auto relative">
                                    <table className="w-full text-right border-collapse text-sm">
                                        <thead className="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200">
                                            <tr>
                                                <th className="p-3 border dark:border-gray-600 sticky right-0 top-0 bg-gray-100 dark:bg-gray-700 z-30 w-48 shadow-[1px_0_0_0_rgba(0,0,0,0.1)]">{t('name_col')}</th>
                                                {showBranchColumn && <th className="p-3 border dark:border-gray-600 sticky top-0 bg-gray-100 dark:bg-gray-700 z-20 w-32">{t('branch')}</th>}
                                                {tableColumns.map((col, i) => {
                                                    if (col.type === 'summary') return <th key={`h-sum-${i}`} className="p-2 border text-center text-xs w-20 bg-blue-100 text-blue-800 font-bold border-blue-200 sticky top-0 z-20">{t('sum_domain', {domain: col.domain})}</th>;
                                                    const item = col.data;
                                                    return (
                                                        <th key={item.id} className="p-2 border dark:border-gray-600 text-center text-xs w-16 sticky top-0 z-20 bg-gray-100 dark:bg-gray-700" title={`${item.sub} - ${item.main}`}>
                                                            <span className="block text-[10px] text-gray-500 mb-1">{item.sub.substring(0,6)}..</span>
                                                            {visibleItems.indexOf(item) + 1}
                                                        </th>
                                                    );
                                                })}
                                                <th className="p-3 border dark:border-gray-600 text-center font-bold sticky top-0 z-20 bg-gray-100 dark:bg-gray-700">{t('total')}</th>
                                                <th className="p-3 border dark:border-gray-600 text-center font-bold text-primary dark:text-blue-400 sticky top-0 z-20 bg-gray-100 dark:bg-gray-700">{t('percent')}</th>
                                                <th className="p-3 border dark:border-gray-600 text-center font-bold sticky top-0 z-20 bg-gray-100 dark:bg-gray-700">{t('rating')}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {filteredResults.map((row, i) => {
                                                // حساب المجموع والنسبة بناءً على الأعمدة الظاهرة فقط
                                                const visibleTotal = visibleItems.reduce((sum, item) => sum + (row.itemScores[item.id] || 0), 0);
                                                // حساب النسبة للأعمدة الظاهرة مع مراعاة التخطي
                                                const visibleValidItems = visibleItems.filter(item => row.itemScores[item.id] !== -1);
                                                const visibleMax = visibleValidItems.length * config.maxScore;
                                                const visibleSum = visibleValidItems.reduce((sum, item) => sum + row.itemScores[item.id], 0);
                                                const visiblePercent = visibleMax > 0 ? (visibleSum / visibleMax) * 100 : 0;
                                                const rating = getRating(visiblePercent, lang);

                                                return (
                                                    <tr key={i} className="hover:bg-blue-50 dark:hover:bg-gray-700 transition border-b dark:border-gray-700">
                                                        <td 
                                                            className="p-3 border dark:border-gray-600 sticky right-0 bg-white dark:bg-gray-800 dark:text-gray-200 z-10 font-medium cursor-pointer text-primary dark:text-blue-400 hover:underline hover:bg-blue-50 shadow-[1px_0_0_0_rgba(0,0,0,0.1)]"
                                                            onClick={() => setSelectedPerson(row)}
                                                            title="انقر لعرض بطاقة التقييم"
                                                        >
                                                            {row.main}
                                                        </td>
                                                        {showBranchColumn && <td className="p-3 border text-gray-600">{row.sub}</td>}
                                                        {tableColumns.map((col, idx) => {
                                                            if (col.type === 'summary') {
                                                                const domainItems = visibleItems.filter(i => i.sub === col.domain);
                                                                const sum = domainItems.reduce((acc, item) => acc + (row.itemScores[item.id] !== -1 ? row.itemScores[item.id] : 0), 0);
                                                                return <td key={`b-sum-${idx}`} className="p-2 border text-center font-bold bg-blue-50 text-blue-900">{sum}</td>;
                                                            }
                                                            const item = col.data;
                                                            return (
                                                                <td key={item.id} className={`p-2 border text-center ${getCellColor(row.itemScores[item.id], config.maxScore)}`}>
                                                                    {row.itemScores[item.id] === -1 ? t('na') : row.itemScores[item.id]}
                                                                </td>
                                                            );
                                                        })}
                                                        <td className="p-3 border text-center font-bold">{visibleSum}</td>
                                                        <td className="p-3 border text-center font-bold text-primary">{visiblePercent.toFixed(1)}%</td>
                                                        <td className={`p-3 border text-center font-bold ${rating.class}`}>{rating.label}</td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                        <tfoot className="bg-gray-100 font-bold text-gray-800 border-t-2 border-gray-300">
                                            <tr>
                                                <td colSpan={showBranchColumn ? "2" : "1"} className="p-3 border text-center sticky right-0 bg-gray-100 z-20 shadow-[1px_0_0_0_rgba(0,0,0,0.1)]">{t('total')} / {t('percent')}</td>
                                                {tableColumns.map((col, i) => {
                                                    if (col.type === 'summary') {
                                                        const domainItems = visibleItems.filter(it => it.sub === col.domain);
                                                        const totalOfSums = domainItems.reduce((acc, item) => acc + item.stat.total, 0);
                                                        return <td key={`f-sum-${i}`} className="p-2 border text-center font-bold bg-blue-100 text-blue-900 border-blue-200">{totalOfSums}</td>;
                                                    }
                                                    const item = col.data;
                                                    return (
                                                        <td key={i} className="p-2 border text-center text-xs">
                                                            <div className="text-blue-600 mb-1" title={t('total')}>{item.stat.total}</div>
                                                            <div className="text-green-700" title={t('percent')}>{item.stat.percent.toFixed(0)}%</div>
                                                        </td>
                                                    );
                                                })}
                                                <td className="p-3 border text-center">-</td>
                                                <td className="p-3 border text-center text-primary">-</td>
                                                <td className="p-3 border text-center">-</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        ) : (
                            <div id="analysis-view-content" className="space-y-8 print-block">
                                {/* KPI Cards Enhanced */}
                                <div id="kpi-section" className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="bg-white rounded-lg shadow-md p-4 border-r-4 border-blue-600 flex flex-col justify-center items-center relative overflow-hidden">
                                        <h4 className="font-bold text-gray-700 mb-2 z-10">{t('kpi_count')}</h4>
                                        <div className="text-3xl font-extrabold text-blue-700 z-10">{filteredResults.length}</div>
                                        <span className="text-xs text-gray-500 mt-1 z-10">{t('count_unit')}</span>
                                        <div className="absolute -left-6 -bottom-6 text-blue-50 opacity-50 pointer-events-none">
                                            <LucideIcon name="search" className="w-32 h-32" />
                                        </div>
                                    </div>
                                    <div className="bg-white rounded-lg shadow-md p-4 border-r-4 border-indigo-600 flex flex-col justify-center items-center relative overflow-hidden">
                                        <h4 className="font-bold text-gray-700 mb-2 z-10">{t('kpi_avg')}</h4>
                                        <div className="text-3xl font-extrabold text-indigo-700 z-10">{overallStats.avgPercent.toFixed(1)}%</div>
                                        <span className="text-xs text-gray-500 mt-1 z-10">{t('visible_items')}</span>
                                        <div className="absolute -left-6 -bottom-6 text-indigo-50 opacity-50 pointer-events-none">
                                            <LucideIcon name="bar-chart-2" className="w-32 h-32" />
                                        </div>
                                    </div>

                                    <KPICard title={t('kpi_names')} 
                                        bestName={kpi.names.max.main} bestScore={kpi.names.max.percent}
                                        worstName={kpi.names.min.main} worstScore={kpi.names.min.percent}
                                        color="purple"
                                        iconName="users"
                                    />

                                    {aggregations.branches.length > 0 && !(aggregations.branches.length === 1 && aggregations.branches[0].name === 'عام') && (
                                        <KPICard title={t('kpi_branches')} 
                                            bestName={kpi.branches.max.name} bestScore={kpi.branches.max.percent}
                                            worstName={kpi.branches.min.name} worstScore={kpi.branches.min.percent}
                                            color="blue"
                                            iconName="home"
                                        />
                                    )}

                                    {aggregations.domains.length > 0 && !(aggregations.domains.length === 1 && aggregations.domains[0].name === 'بدون مجال') && (
                                        <KPICard title={t('kpi_domains')} 
                                            bestName={kpi.domains.max.name} bestScore={kpi.domains.max.percent}
                                            worstName={kpi.domains.min.name} worstScore={kpi.domains.min.percent}
                                            color="amber"
                                            iconName="file-spreadsheet"
                                        />
                                    )}

                                    <KPICard title={t('kpi_items')} 
                                        bestName={kpi.items.max.main} bestScore={kpi.items.max.percent}
                                        worstName={kpi.items.min.main} worstScore={kpi.items.min.percent}
                                        color="teal"
                                        iconName="check-circle"
                                    />
                                </div>

                                {/* Charts */}
                                <div className="grid md:grid-cols-3 gap-6 break-inside-avoid">
                                    {aggregations.branches.length > 1 && (
                                        <div id="chart-branch-container" className="bg-white p-4 rounded shadow border h-80">
                                            <canvas id="chartBranch"></canvas>
                                        </div>
                                    )}
                                    {aggregations.domains.length > 1 && (
                                        <div id="chart-domain-container" className="bg-white p-4 rounded shadow border h-80">
                                            <canvas id="chartDomain"></canvas>
                                        </div>
                                    )}
                                    <div id="chart-rating-container" className="bg-white p-4 rounded shadow border h-80">
                                        <h3 className="font-bold mb-2 text-center text-gray-700">{t('chart_rating')}</h3>
                                        <canvas id="chartRating"></canvas>
                                    </div>
                                </div>
                                <div id="chart-names-container" className="bg-white p-4 rounded shadow border h-[800px] break-inside-avoid break-before-page">
                                    <h3 className="font-bold mb-2 text-center text-cyan-700">{t('name_comparison')}</h3>
                                    <canvas id="chartNames"></canvas>
                                </div>
                                <div id="chart-items-container" className="bg-white p-4 rounded shadow border h-[800px] break-inside-avoid break-before-page">
                                    <h3 className="font-bold mb-2 text-center text-teal-800">{t('item_analysis')}</h3>
                                    <canvas id="chartItems"></canvas>
                                </div>
                            </div>
                        )}

                        {/* بطاقة التقييم الفردي (Modal) */}
                        {selectedPerson && (
                            <Modal isOpen={true} onClose={() => setSelectedPerson(null)} title={t('results_title')} className="printable-modal">
                                <div className="space-y-6" id="printable-card">
                                    <SingleCard 
                                        config={config} 
                                        person={selectedPerson} 
                                        itemsByDomain={itemsByDomain} 
                                        getCellColor={getCellColor} 
                                        t={t}
                                        lang={lang}
                                    />

                                    {/* زر الطباعة */}
                                    <div className="mt-6 text-center no-print-modal pt-4 border-t">
                                        <button onClick={exportCardPDF} data-html2canvas-ignore className="bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-full flex items-center gap-2 mx-auto shadow-lg transition-transform hover:scale-105">
                                            <Icons.File /> {t('export_pdf_btn')}
                                        </button>
                                    </div>
                                </div>
                            </Modal>
                        )}

                        {/* حاوية مخفية للتصدير الجماعي */}
                        {isExporting && (
                            <div style={{ position: 'absolute', left: '-9999px', top: 0 }}>
                                {filteredResults.map(person => (
                                    <div key={person.id} className="bulk-card-item">
                                        <SingleCard config={config} person={person} itemsByDomain={itemsByDomain} getCellColor={getCellColor} t={t} lang={lang} />
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    <Footer t={t} />
                </div>
            );
        };

        const Footer = ({ t }) => (
            <footer className="bg-gray-800 text-gray-300 py-4 text-center text-sm w-full mt-auto print-only">
                {t('dev_by')}
            </footer>
        );

        // --- المكون الرئيسي ---
        const App = () => {
            const [screen, setScreen] = useState('welcome');
            const [config, setConfig] = useState({ items: [], names: [], maxScore: 10, orgName: '', evaluatorName: '', logo: null });
            const [scores, setScores] = useState({});
            const [hasDraft, setHasDraft] = useState(false);
            const [darkMode, setDarkMode] = useState(false);
            const [lang, setLang] = useState('ar');

            useEffect(() => {
                if (darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [darkMode]);

            useEffect(() => {
                document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
                document.documentElement.lang = lang;
            }, [lang]);

            const toggleTheme = () => setDarkMode(!darkMode);
            const toggleLang = () => setLang(prev => prev === 'ar' ? 'en' : 'ar');

            const t = (key, params = {}) => {
                let text = translations[lang][key] || key;
                Object.keys(params).forEach(k => {
                    text = text.replace(`{${k}}`, params[k]);
                });
                return text;
            };

            useEffect(() => {
                const draft = localStorage.getItem('eval_draft');
                if(draft) setHasDraft(true);
            }, []);

            const saveDraft = (currentScores) => {
                setScores(currentScores);
                const data = { config, scores: currentScores, date: new Date().toISOString() };
                localStorage.setItem('eval_draft', JSON.stringify(data));
                setHasDraft(true);
            };

            const loadDraft = () => {
                const draft = localStorage.getItem('eval_draft');
                if(draft) {
                    const data = JSON.parse(draft);
                    setConfig(data.config);
                    setScores(data.scores);
                    setScreen('eval');
                }
            };

            const cancelAll = () => {
                setScreen('welcome');
                setScores({});
                setConfig({ items: [], names: [], maxScore: 10, orgName: '', evaluatorName: '', logo: null });
                // لا نحذف المسودة حتى يقرر المستخدم حذفها يدوياً أو الكتابة عليها
                window.location.reload(); 
            };

            const renderScreen = () => {
                switch(screen) {
                    case 'welcome': return <WelcomeScreen onStart={() => setScreen('setup')} t={t} toggleLang={toggleLang} lang={lang} />;
                    case 'setup': return <SetupScreen config={config} setConfig={setConfig} onComplete={() => setScreen('eval')} hasDraft={hasDraft} onLoadDraft={loadDraft} setHasDraft={setHasDraft} isLocked={Object.keys(scores).length > 0} onResetScores={() => setScores({})} darkMode={darkMode} toggleTheme={toggleTheme} t={t} toggleLang={toggleLang} />;
                    case 'eval': return <EvaluationScreen config={config} initialScores={scores} onFinish={(finalScores) => { setScores(finalScores); setScreen('results'); }} onSaveDraft={saveDraft} onCancel={cancelAll} onBackToSetup={() => setScreen('setup')} darkMode={darkMode} toggleTheme={toggleTheme} t={t} toggleLang={toggleLang} />;
                    case 'results': return <ResultsAndAnalysis config={config} scores={scores} onBackToEdit={() => setScreen('eval')} onGoHome={() => setScreen('setup')} darkMode={darkMode} toggleTheme={toggleTheme} t={t} toggleLang={toggleLang} lang={lang} />;
                    default: return <WelcomeScreen t={t} toggleLang={toggleLang} lang={lang} />;
                }
            };

            return (
                <div className={`font-sans ${lang === 'ar' ? 'text-right' : 'text-left'}`} dir={lang === 'ar' ? 'rtl' : 'ltr'}>
                    {renderScreen()}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>





<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://openfpcdn.io/fingerprintjs/v4"></script>

<script>
    // 🔴🔴 استبدل القيم هنا أيضاً ببيانات مشروعك 🔴🔴
    const SUPABASE_URL = 'https://nbtuyrieidgqmntvahvn.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_3C5cYX5KxHTWzQN44IzlLA_yZzEumVG';
    
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // دالة التشغيل الرئيسية
    async function initApp() {
        // 1. هل المستخدم مسجل دخول؟
        const { data: { user } } = await supabase.auth.getUser();

        if (!user) {
            // غير مسجل؟ اذهب لصفحة الدخول
            window.location.href = 'login.html';
            return;
        }

        // 2. تسجيل بيانات المستخدم (الاسم والإيميل) تلقائياً في الجدول
        // هذا يضمن تحديث البيانات كل مرة يدخل فيها
        await supabase.from('profiles').upsert({
            id: user.id,
            email: user.email,
            full_name: user.user_metadata.full_name,
            last_sync: new Date().toISOString() // تحديث وقت الظهور
        }, { onConflict: 'id' }); // لا تنشئ جديداً إذا كان موجوداً، بل حدثه

        // 3. جلب حالة الاشتراك وتاريخ التسجيل
        let { data: profile } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', user.id)
            .single();

        // 4. الحسابات الزمنية
        const now = new Date();
        const regDate = new Date(profile.created_at); // تاريخ التسجيل
        const lastSyncLocal = new Date(localStorage.getItem('last_sync_local') || profile.last_sync); // للمقارنة الأوفلاين

        // حساب الفرق بالأيام (للتجربة المجانية)
        const daysSinceRegistration = Math.ceil((now - regDate) / (1000 * 60 * 60 * 24));
        
        // حساب الفرق (للأوفلاين)
        const daysOffline = Math.ceil((now - lastSyncLocal) / (1000 * 60 * 60 * 24));

        // 5. منطق الحجب (The Logic)
        
        // أ) هل انتهت الـ 15 يوماً والحساب غير مفعل يدوياً؟
        if (daysSinceRegistration > 15 && profile.is_active === false) {
            blockAccess("عذراً، انتهت فترتك التجريبية (15 يوماً).", user.id);
            return;
        }

        // ب) هل مر 5 أيام دون إنترنت؟
        if (!navigator.onLine && daysOffline > 5) {
            blockAccess("يرجى الاتصال بالإنترنت للتحقق من صلاحية اشتراكك.", user.id);
            return;
        }

        // إذا وصلنا هنا، فالمستخدم وضعه سليم
        // نخزن وقت آخر ظهور محلياً
        if (navigator.onLine) {
            localStorage.setItem('last_sync_local', now.toISOString());
        }
        
        // هنا يمكنك إضافة كود بصمة الجهاز FingerprintJS لمنع تعدد الحسابات (خطوة متقدمة)
    }

    // دالة إظهار شاشة القفل
    function blockAccess(message, userId) {
        document.body.innerHTML = `
            <div style="height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; font-family:sans-serif; background:#fff0f0;">
                <h1 style="color:#d32f2f;">⛔ توقف التطبيق</h1>
                <p style="font-size:18px; margin:20px;">${message}</p>
                
                <a href="https://wa.me/9665XXXXXXXX?text=مرحباً، أريد تفعيل حسابي رقم: ${userId}" 
                   style="background:#25D366; color:white; padding:15px 30px; text-decoration:none; border-radius:50px; font-weight:bold; font-size:16px;">
                   تواصل عبر واتساب للتفعيل
                </a>
                
                <p style="margin-top:30px; color:#666; font-size:12px;">رقم الحساب (ID):<br>${userId}</p>
            </div>
        `;
    }

    // تشغيل النظام
    initApp();
</script>





</body>
</html>